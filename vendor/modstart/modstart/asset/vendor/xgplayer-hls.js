!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):(e=e||self).HlsPlayer=t(e.Player)}(this,function(i){"use strict";i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;var e,t,r={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},n={SEEK:"SEEK"},s={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY",LOADER_TTFB:"LOADER_TTFB"},a={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO",ISKEYFRAME:"ISKEYFRAME"},o={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},u={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR",MSE_WRONG_TRACK_ADD:"MSE_WRONG_TRACK_ADD"},l={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},h=Object.assign({},s,a,o,u,l,n,r),c=[],d=[];for(e in h)h.hasOwnProperty(e)&&c.push(h[e]);for(t in h)h.hasOwnProperty(t)&&d.push(h[t]);var f={ALLEVENTS:h,HLS_EVENTS:l,REMUX_EVENTS:o,DEMUX_EVENTS:a,MSE_EVENTS:u,LOADER_EVENTS:s,FlvAllowedEvents:c,HlsAllowedEvents:d,CRYPTO_EVENTS:{START_DECRYPTOO:"START_DECRYPTO",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:n,BROWSER_EVENTS:r};function p(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=(function(e,t,i){return t&&p(e.prototype,t),i&&p(e,i),e}(v,[{key:"push",value:function(e,t,i,r,n,s){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i,id:r,cc:n,isLast:s||!1},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e,id:this._ts[e].id}),delete this._list[this._ts[e].start],delete this._ts[e],--this.fragLength)}},{key:"_calcAvgFrgmentDuration",value:function(e){if(!e.frags)return e.targetduration;var t=e.frags.length;return Math.floor(e.duration/t/1e3)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,this._avgSegmentDuration=Math.min(this.targetduration,this._calcAvgFrgmentDuration(e)),e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),this.end=e.end||!1,e.sequence||(e.sequence=0),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, "+e.sequence);var i=e.frags.length;this.logger&&this.logger.log("PLAYLIST","new playlist ["+e.sequence+", "+(e.sequence+i-1)+"]"),this.sequence=e.sequence;for(var r=[],n=0;n<i;n++){var s=e.frags[n];!this._ts[s.url]&&this.downloadedUrls.indexOf(s.url)<0&&(r.push(s.url),this.push(s.url,s.duration,s.discontinue,s.id,s.cc,s.isLast))}if(r.length<1)throw new Error("Can not read ts file list.");if(t)for(var a=this.getTsList(),o=0;o<a.length;o++)r.indexOf(a[o])<0&&this.deleteFrag(a[o])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){e=this._ts[e];e&&(e.downloaded=t)}},{key:"downloading",value:function(e,t){e=this._ts[e];e&&(e.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t=Object.keys(this._list),i=void 0;if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(t.length<1||e>=this.duration)){for(var t=t.sort(function(e,t){return parseFloat(e)-parseFloat(t)}),r=0;r<t.length&&e>=parseInt(t[r]);r++){var n=this._list[t[r]],i={url:n,downloaded:this._ts[n].downloaded,downloading:this._ts[n].downloading,time:parseInt(t[r]),duration:parseInt(this._ts[n].duration),id:this._ts[n].id,cc:this._ts[n].cc,isLast:this._ts[n].isLast};this.autoclear&&this._lastget&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=i}return i&&this.downloadedUrls.push(i.url),i}}},{key:"getLastDownloadedTs",value:function(){for(var e=Object.keys(this._list).sort(function(e,t){return Number(e)-Number(t)}),t=void 0,i=0;i<e.length;i++){var r=this._list[e[i]],n=this._ts[r].downloaded,s=this._ts[r].downloading;if(!n)break;t={url:r,downloaded:n,downloading:s,time:parseInt(e[i]),duration:parseInt(this._ts[r].duration)}}return t}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=Object.keys(this._ts),t=0,i=e.length;t<i;t++){var r=this._ts[e[t]];r.downloaded=!1,r.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this.autoclear=!1}},{key:"resetSequence",value:function(){this.sequence=-1}},{key:"list",get:function(){return this._list}},{key:"baseURL",set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)},get:function(){return this._baseURL}},{key:"avgSegmentDuration",get:function(){return this._avgSegmentDuration}}]),v);function _(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e){!function(e){if(!(e instanceof v))throw new TypeError("Cannot call a class as a function")}(this),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this.end=!1,this.autoclear=e.autoclear||!1,this.logger=e.logger,this.downloadedUrls=[],this._avgSegmentDuration=4}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(){m(this,g),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0}var E=(function(e,t,i){return t&&_(e.prototype,t),i&&_(e,i),e}(T,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new g,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.clear()}}]),T);function b(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function T(){m(this,T),this.sources={}}var k=(function(e,t,i){return t&&b(e.prototype,t),i&&b(e,i),e}(D,[{key:"back",value:function(e){this.position-=e}},{key:"getUint8",value:function(e){return this.dataview.getUint8(e)}},{key:"skip",value:function(e){for(var t=Math.floor(e/4),e=e%4,i=0;i<t;i++)D.readByte(this.dataview,4);0<e&&D.readByte(this.dataview,e)}},{key:"readUint8",value:function(){return D.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return D.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return D.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return D.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return D.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return D.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return D.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return D.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),D),S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t,i){return t&&A(e.prototype,t),i&&A(e,i),e};function A(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function D(e){if(function(e){if(!(e instanceof D))throw new TypeError("Cannot call a class as a function")}(this),!(e instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=e,this.dataview=new DataView(e),this.dataview.position=0}function R(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":S(t))&&"function"!=typeof t?e:t}function w(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":S(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function O(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var L=(u(P,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"destroy",value:function(){this.reset(),this.id=-1}}]),P),x=(w(B,L),B),U=(w(C,L),u(C,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),C);function M(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function C(){O(this,C);var e=R(this,(C.__proto__||Object.getPrototypeOf(C)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e.sequenceNumber=0,e}function B(){O(this,B);var e=R(this,(B.__proto__||Object.getPrototypeOf(B)).call(this));return e.TAG="AudioTrack",e.type="audio",e}function P(){O(this,P),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}var I=((u(function e(){O(this,e),this.audioTrack=null,this.videoTrack=null},[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),function(e,t,i){return t&&M(e.prototype,t),i&&M(e,i),e})(G,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){t=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,t}for(var i=new Uint8Array(e),r=0;0<this.array.length&&0<e;){if(this.offset+e<this.array[0].length){var n=this.array[0].slice(this.offset,this.offset+e);i.set(n,r),this.offset+=e,this.length-=e,e=0;break}n=this.array[0].length-this.offset;i.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=n,this.length-=n,e-=n}return i}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;)r<this.array[0].length?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++;return i}}]),G),s=function(e,t,i){return t&&F(e.prototype,t),i&&F(e,i),e};function F(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function G(e){!function(e){if(!(e instanceof G))throw new TypeError("Cannot call a class as a function")}(this),this.length=e||0,this.historyLen=e||0,this.array=[],this.offset=0}function N(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var j=(s(Y,[{key:"destroy",value:function(){this.init=null}}]),Y),V=(s(X,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),X),n=function(e,t,i){return t&&H(e.prototype,t),i&&H(e,i),e};function H(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function X(e){N(this,X);var t={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return e?Object.assign({},t,e):t}function Y(e){N(this,Y);var t={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return e?Object.assign({},t,e):t}function W(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var z=(n(Q,null,[{key:"getDefault",value:function(){return{dts:-1,pts:-1,originDts:-1,data:new Uint8Array}}}]),Q),K=(n(Z,null,[{key:"getDefault",value:function(){return{dts:-1,pts:void 0,isKeyframe:!1,originDts:-1,data:new Uint8Array,nals:[]}}}]),Z);function q(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Z(e){W(this,Z);var t=Z.getDefault();return e?Object.assign({},t,e):t}function Q(e){W(this,Q);var t=Q.getDefault();return e?Object.assign({},t,e):t}function J(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0}var $=(function(e,t,i){return t&&q(e.prototype,t),i&&q(e,i),e}(te,[{key:"isComplete",value:function(){return te.isBaseInfoReady(this)&&te.isVideoReady(this)&&te.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:J},{key:"isVideoReady",value:function(e){return!e.hasVideo||J(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||J(e.video)}}]),te);function ee(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function te(){!function(e){if(!(e instanceof te))throw new TypeError("Cannot call a class as a function")}(this),this.mimeType=null,this.duration=null,this.hasVideo=!1,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=!1,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}var ie=(function(e,t,i){return t&&ee(e.prototype,t),i&&ee(e,i),e}(re,null,[{key:"getDefault",value:function(){return{id:-1,url:"",start:-1,duration:-1,discontinue:!1,cc:-1}}}]),re);function re(e){!function(e){if(!(e instanceof re))throw new TypeError("Cannot call a class as a function")}(this);e=Object.assign({},re.getDefault(),e);this.id=e.id,this.url=e.url,this.start=e.start,this.duration=e.duration,this.discontinue=e.discontinue,this.cc=e.cc}function ne(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function se(e,t){return e(t={exports:{}},t.exports),t.exports}function ae(e,t,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);return void 0!==r?"value"in r?r.value:void 0!==(r=r.get)?r.call(i):void 0:null===(e=Object.getPrototypeOf(e))?void 0:ae(e,t,i)}var oe=se(function(e){var r=Object.prototype.hasOwnProperty,f="~";function i(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,i,r,n){if("function"!=typeof i)throw new TypeError("The listener must be a function");n=new s(i,r||e,n),t=f?f+t:t;return e._events[t]?e._events[t].fn?e._events[t]=[e._events[t],n]:e._events[t].push(n):(e._events[t]=n,e._eventsCount++),e}function u(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function t(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(f=!1)),t.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(f?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},t.prototype.listeners=function(e){var e=f?f+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var i=0,r=t.length,n=new Array(r);i<r;i++)n[i]=t[i].fn;return n},t.prototype.listenerCount=function(e){e=f?f+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,i,r,n,s){var a=f?f+e:e;if(!this._events[a])return!1;var o,u=this._events[a],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,i),!0;case 4:return u.fn.call(u.context,t,i,r),!0;case 5:return u.fn.call(u.context,t,i,r,n),!0;case 6:return u.fn.call(u.context,t,i,r,n,s),!0}for(d=1,o=new Array(l-1);d<l;d++)o[d-1]=arguments[d];u.fn.apply(u.context,o)}else for(var h,c=u.length,d=0;d<c;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),l){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,i);break;case 4:u[d].fn.call(u[d].context,t,i,r);break;default:if(!o)for(h=1,o=new Array(l-1);h<l;h++)o[h-1]=arguments[h];u[d].fn.apply(u[d].context,o)}return!0},t.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},t.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},t.prototype.removeListener=function(e,t,i,r){e=f?f+e:e;if(!this._events[e])return this;if(!t)return u(this,e),this;var n=this._events[e];if(n.fn)n.fn!==t||r&&!n.once||i&&n.context!==i||u(this,e);else{for(var s=0,a=[],o=n.length;s<o;s++)(n[s].fn!==t||r&&!n[s].once||i&&n[s].context!==i)&&a.push(n[s]);a.length?this._events[e]=1===a.length?a[0]:a:u(this,e)}return this},t.prototype.removeAllListeners=function(e){return e?(e=f?f+e:e,this._events[e]&&u(this,e)):(this._events=new i,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=f,e.exports=t.EventEmitter=t}),ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},le=function(e,t,i){return t&&he(e.prototype,t),i&&he(e,i),e};function he(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ce(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var de="__TO__",fe=(le(ye,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],s=i[1],a=i[2],o=i[3];if(this._clsMap[e]){o=new this._clsMap[e](n,s,a,o);return(this._instanceMap[e]=o).init&&o.init(),o}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(l,e){var r=this,h=this._emitter,o=this._isMessageNameValid.bind(this),u=this,e=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":ue(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(n,e),le(n,[{key:"on",value:function(e,t){return o(e),this.listeners[e]?this.listeners[e].push(t):this.listeners[e]=[t],h.on(e+de+l,t),h.on(e,t)}},{key:"before",value:function(e,t){o(e),u._hooks[e]?u._hooks[e].push(t):u._hooks[e]=[t]}},{key:"once",value:function(e,t){return o(e),this.onceListeners[e]?this.onceListeners[e].push(t):this.onceListeners[e]=[t],h.once(e+de+l,t),h.once(e,t)}},{key:"emit",value:function(e){o(e);for(var t=u._hooks?u._hooks[e]:null,i=arguments.length,r=Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];if(t)for(var s=0,a=t.length;s<a;s++)t[s].apply(void 0,r);return h.emit.apply(h,[e].concat(r))}},{key:"emitTo",value:function(e,t){o(t);for(var i=arguments.length,r=Array(2<i?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];return h.emit.apply(h,[t+de+e].concat(r))}},{key:"off",value:function(e,t){return o(e),h.off(e,t)}},{key:"removeListeners",value:function(){var e,t,i=Object.prototype.hasOwnProperty.bind(this.listeners);for(e in this.listeners)if(i(e))for(var r=this.listeners[e]||[],n=0;n<r.length;n++){var s=r[n];h.off(e,s),h.off(e+de+l,s)}for(t in this.onceListeners)if(i(t))for(var a=this.onceListeners[t]||[],o=0;o<a.length;o++){var u=a[o];h.off(t,u),h.off(t+de+l,u)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete u._instanceMap[l],ae(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this))return ae(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this);this._context=null}},{key:"_player",get:function(){return this._context?this._context._player:null},set:function(e){this._context&&(this._context._player=e)}},{key:"_pluginConfig",get:function(){return this._context?this._context._configs:null}}]),n);function n(e,t,i){ce(this,n);i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":ue(t))&&"function"!=typeof t?e:t}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t,i));return i.listeners={},i.onceListeners={},i.TAG=l,i._context=u,i}return this._clsMap[l]=e,function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return r.initInstance.apply(r,[l].concat(t))}}},{key:"seek",value:function(e){this._emitter.emit(f.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var t=this;Object.keys(this._instanceMap).forEach(function(e){t._instanceMap[e].destroy&&t._instanceMap[e].destroy()})}},{key:"destroy",value:function(){this.destroyInstances(),this._emitter&&this._emitter.removeAllListeners(),this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._hooks=null,this._player=null,this._configs=null}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),ye),r=function(e,t,i){return t&&pe(e.prototype,t),i&&pe(e,i),e};function pe(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ye(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];ce(this,ye),this._emitter=new oe,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new $,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=i,this._configs=t,this._player=e,this._hooks={}}var _e=f.CRYPTO_EVENTS,ve=(r(ge,[{key:"init",value:function(){this.on(_e.START_DECRYPTO,this.decrypto.bind(this))}},{key:"decrypto",value:function(){var t=this;this.aeskey?this.decryptoData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(e){t.aeskey=e,t.decryptoData()})}},{key:"decryptoData",value:function(){var t=this,e=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=e.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then(function(e){i.push(new Uint8Array(e)),t.emit(_e.DECRYPTED),t.decryptoData(r)})}}]),ge),u=function(e,t,i){return t&&me(e.prototype,t),i&&me(e,i),e};function me(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ge(e){!function(e){if(!(e instanceof ge))throw new TypeError("Cannot call a class as a function")}(this),this.inputBuffer=e.inputbuffer,this.outputBuffer=e.outputbuffer,this.key=e.key,this.iv=e.iv,this.method=e.method,this.crypto=window.crypto||window.msCrypto}var Ee=f.MSE_EVENTS,be=(u(ke,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(e,t){if(this._context=e,this.emit=e._emitter.emit.bind(e._emitter),!t)for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||ke.clearBuffer(r)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(Ee.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;if(e&&t){for(var e=e.sources,r=!1,n=0,s=Object.keys(e).length;n<s;n++){var a=Object.keys(e)[n],r=!1;"audio"===a?i=t.audioTrack:"video"===a&&(i=t.videoTrack),i&&null!==e[a].init&&e[a].data.length&&(r=!0)}if(r&&!(1<Object.keys(this.sourceBuffers).length)){for(var o=0,u=Object.keys(e).length;o<u;o++){var l=Object.keys(e)[o];if(!this.sourceBuffers[l]){var h=e[l],h="video"===l?"video/mp4;codecs="+h.mimetype:"audio/mp4;codecs="+h.mimetype;try{var c=this.mediaSource.addSourceBuffer(h);(this.sourceBuffers[l]=c).addEventListener("updateend",this.onUpdateEnd)}catch(e){if(22===e.code&&0<Object.keys(this.sourceBuffers).length)return this.emit(Ee.MSE_WRONG_TRACK_ADD,l);this.emit(Ee.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){if(this.mediaSource&&"closed"!==this.mediaSource.readyState){this._doCleanupSourceBuffer();var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e&&!(Object.keys(this.sourceBuffers).length<this.sourceBufferLen))for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i];if(!r.updating){var n=e.sources[i];if(this["no"+i])n.data=[],n.init.buffer=null;else if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){i=n.data.shift();if(i)try{r.appendBuffer(i.buffer.buffer)}catch(e){n.data.unshift(i)}}}}}}},{key:"endOfStream",value:function(){try{"open"===this.mediaSource.readyState&&this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;try{for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||t<e&&r.remove(t,e)}}catch(e){}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var r=Object.keys(this.sourceBuffers)[i],n=this.sourceBuffers[r],s=n.buffered,a=!1,o=0;o<s.length;o++){var u=s.start(o),l=s.end(o);u<=e&&e<l+3?180<=e-u&&(a=!0,t[r].push({start:u,end:e-180})):l<e&&180<=e-u&&(a=!0,t[r].push({start:u,end:l}))}a&&!n.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],r=e[t];r.length&&!i.updating;){var n=r.shift();try{n&&n.end>n.start&&i.remove(n.start,n.end)}catch(e){}}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],e=0;e<Object.keys(this.sourceBuffers).length;e++)!function(e){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[e]],e=void 0,e=r.updating?new Promise(function(i){r.addEventListener("updateend",function e(){var t=3;setTimeout(function e(){r.updating?0<t?(setTimeout(e,200),t--):i():(ke.clearBuffer(r),r.addEventListener("updateend",function(){i()}))},200),r.removeEventListener("updateend",e)})}):new Promise(function(e){ke.clearBuffer(r),r.addEventListener("updateend",function(){e()})});i.push(e)}(e);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],e=0;e<Object.keys(this.sourceBuffers).length;e++)!function(e){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[e]];r.removeEventListener("updateend",t.onUpdateEnd);e=void 0,e=r.updating?new Promise(function(i){r.addEventListener("updateend",function e(){var t=3;setTimeout(function e(){r.updating?0<t?(setTimeout(e,200),t--):i():(ke.clearBuffer(r),r.addEventListener("updateend",function(){i()}))},200),r.removeEventListener("updateend",e)})}):new Promise(function(e){ke.clearBuffer(r),r.addEventListener("updateend",function(){e()})});i.push(e)}(e);return Promise.all(i)}},{key:"destroy",value:function(){var r=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then(function(){for(var e=Object.keys(r.sourceBuffers),t=0;t<e.length;t++){var i=r.sourceBuffers[e[t]];delete r.sourceBuffers[e[t]],"open"===r.mediaSource.readyState&&r.mediaSource.removeSourceBuffer(i)}r.endOfStream();try{window.URL.revokeObjectURL(r.url)}catch(e){}r.url=null,r.configs={},r.container=null,r.mediaSource=null,r.sourceBuffers={},r.preloadTime=1,r.onSourceOpen=null,r.onTimeUpdate=null,r.onUpdateEnd=null,r.onWaiting=null,r.noaudio=void 0,r.novideo=void 0})):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",set:function(e){this._url=e},get:function(){if(!this._url)try{this._url=window.URL.createObjectURL(this.mediaSource)}catch(e){}return this._url}}],[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);e.remove(0,i)}catch(e){}}}]),ke);function Te(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ke(e,t){!function(e){if(!(e instanceof ke))throw new TypeError("Cannot call a class as a function")}(this),t&&(this._context=t,this.emit=t._emitter.emit.bind(t._emitter)),this.TAG="MSE",this.configs=Object.assign({},e),this.container=this.configs.container,this.format=this.configs.format,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1}var Se=(function(e,t,i){return t&&Te(e.prototype,t),i&&Te(e,i),e}(we,[{key:"reset",value:function(){this._firstCheckpoint=this._lastCheckpoint=0,this._intervalBytes=0,this._lastSamplingBytes=0}},{key:"addBytes",value:function(e){var t=this._now()-this._lastCheckpoint;0===this._firstCheckpoint?(this._firstCheckpoint=this._now(),this._lastCheckpoint=this._firstCheckpoint,this._intervalBytes+=e):t<5e3?this._intervalBytes+=e:(this._lastSamplingBytes=this._intervalBytes/(t/1e3),this._intervalBytes=e,this._lastCheckpoint=this._now())}},{key:"currentKBps",get:function(){this.addBytes(0);var e=(this._now()-this._lastCheckpoint)/1e3;return this._intervalBytes/(e=0===e?1:e)/1024}},{key:"lastSamplingKBps",get:function(){return this.addBytes(0),0!==this._lastSamplingBytes?this._lastSamplingBytes/1024:500<=this._now()-this._lastCheckpoint?this.currentKBps:0}}]),we),Ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},De="function"==typeof Symbol&&"symbol"===Ae(Symbol.iterator)?function(e){return void 0===e?"undefined":Ae(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Ae(e)},s=function(e,t,i){return t&&Re(e.prototype,t),i&&Re(e,i),e};function Re(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function we(){!function(e){if(!(e instanceof we))throw new TypeError("Cannot call a class as a function")}(this),this._firstCheckpoint=0,this._lastCheckpoint=0,this._intervalBytes=0,this._lastSamplingBytes=0,this._now=Date.now}var Oe,Le=f.LOADER_EVENTS,xe=(s(Me,[{key:"init",value:function(){this.on(Le.LADER_START,this.load.bind(this))}},{key:"fetch",value:(Oe=function(e,t,i){var r=this,n=null;this.abortControllerEnabled&&(this.abortController=new window.AbortController),Object.assign(t,{signal:this.abortController?this.abortController.signal:void 0});var s=(new Date).getTime();return Promise.race([fetch(e,t),new Promise(function(e,t){n=setTimeout(function(){t({code:999,message:"fetch timeout"}),r.abortController&&r.abortController.abort()},i||1e4)})]).then(function(e){n&&(clearTimeout(n),n=null);var t=(new Date).getTime();return r.emit(Le.LOADER_TTFB,{start:s,end:t,elapsed:t-s}),e})},Ce.toString=function(){return Oe.toString()},Ce)},{key:"internalLoad",value:function(t,i,r,n){var s=this,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,o=arguments[5];if(!this._destroyed)return this.loading=!0,this.fetch(this.url,i,o).then(function(e){return s._destroyed||s.emit(Le.LOADER_RESPONSE_HEADERS,s.TAG,e.headers),e.ok?(s.status=e.status,Promise.resolve().then(function(){s._onFetchResponse(e)}),Promise.resolve(e)):void(0<r--?s._retryTimer=setTimeout(function(){return s.emit(Le.LOADER_RETRY,s.TAG,{response:e,reason:"response not ok",retryTime:n-r}),s.internalLoad(t,i,r,n,a,o)},a):(s.loading=!1,s.emit(Le.LOADER_ERROR,s.TAG,{code:e.status||21,message:e.status+" ("+e.statusText+")"})))}).catch(function(e){s._destroyed?s.loading=!1:0<r--?s._retryTimer=setTimeout(function(){return s.emit(Le.LOADER_RETRY,s.TAG,{error:e,reason:"fetch error",retryTime:n-r}),s.internalLoad(t,i,r,n,a,o)},a):(s.loading=!1,e&&"AbortError"===e.name||s.emit(Le.LOADER_ERROR,s.TAG,Object.assign({code:21},e)))})}},{key:"load",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=i.retryCount,n=i.retryDelay,i=i.loadTimeout,r=void 0===r?3:r;this.url=e,this._canceled=!1;t=this.getParams(t);return this.internalLoad(e,t,r,r,n,i)}},{key:"_onFetchResponse",value:function(e){var t=this,i=this,r=this._context.getInstance(this.buffer);this._loaderTaskNo++;var n=this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then(function(e){i.loading=!1,i._canceled||i._destroyed||(r?(r.push(e),i.emit(Le.LOADER_COMPLETE,r)):i.emit(Le.LOADER_COMPLETE,e))});break;case 1:e.text().then(function(e){i.loading=!1,i._canceled||i._destroyed||(r?(r.push(e),i.emit(Le.LOADER_COMPLETE,r)):i.emit(Le.LOADER_COMPLETE,e))});break;case 3:e.arrayBuffer().then(function(e){i.loading=!1,i._canceled||i._destroyed||(r?(r.push(new Uint8Array(e)),t._speed.addBytes(e.byteLength),i.emit(Le.LOADER_COMPLETE,r)):i.emit(Le.LOADER_COMPLETE,e))}).catch(function(){});break;default:return this._onReader(e.body.getReader(),n)}}},{key:"_onReader",value:function(t,i){var r=this,n=this._context.getInstance(this.buffer);if(!n&&this._reader||this._destroyed)try{this._reader.cancel()}catch(t){}this._reader=t,!1!==this.loading&&(this._noDataTimer=setTimeout(function(){!1!==r.loading&&r.emit(Le.LOADER_COMPLETE)},3e3),this._reader&&this._reader.read().then(function(e){if(clearTimeout(r._noDataTimer),!r._canceled&&!r._destroyed)return e.done?(r.loading=!1,r.status=0,void Promise.resolve().then(function(){r.emit(Le.LOADER_COMPLETE,n)})):(n.push(e.value),r._speed.addBytes(e.value.byteLength),Promise.resolve().then(function(){r.emit(Le.LOADER_DATALOADED,n)}),r._onReader(t,i));if(r._reader)try{r._reader.cancel()}catch(e){}}).catch(function(e){clearTimeout(r._noDataTimer),r.loading=!1,e&&"AbortError"===e.name||r.emit(Le.LOADER_ERROR,r.TAG,e)}))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,e={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===De(this.configs.headers)){var r,n=this.configs.headers;for(r in n)n.hasOwnProperty(r)&&i.append(r,n[r])}if("object"===De(t.headers)){var s,a=t.headers;for(s in a)a.hasOwnProperty(s)&&i.append(s,a[s])}return!1===t.cors&&(e.mode="same-origin"),t.withCredentials&&(e.credentials="include"),e}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}clearTimeout(this._noDataTimer),this._canceled=!0,this.abortController&&this.abortController.abort()}},{key:"destroy",value:function(){this._destroyed=!0,clearTimeout(this._retryTimer),clearTimeout(this._noDataTimer),this.cancel(),this._speed.reset()}},{key:"currentSpeed",get:function(){return this._speed.lastSamplingKBps}}],[{key:"isSupported",value:function(){return!!window.fetch}},{key:"type",get:function(){return"loader"}}]),Me);function Ue(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Me(e){!function(e){if(!(e instanceof Me))throw new TypeError("Cannot call a class as a function")}(this),this.configs=Object.assign({},e),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0,this._ttfb=0,this._speed=new Se,window.AbortController&&(this.abortControllerEnabled=!0)}function Ce(e,t,i){return Oe.apply(this,arguments)}var Be=(function(e,t,i){return t&&Ue(e.prototype,t),i&&Ue(e,i),e}(Ie,[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}]),new Ie),n=function(e,t,i){return t&&Pe(e.prototype,t),i&&Pe(e,i),e};function Pe(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ie(){var c=this;!function(e){if(!(e instanceof Ie))throw new TypeError("Cannot call a class as a function")}(this);try{var e=/xgd=(\d)/.exec(document.cookie);this._status=!!e,this._level=e&&e[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error"].forEach(function(h){c[h]=function(e,t,i,r,n,s,a,o,u,l){c._status&&(e=e,u=[t,i,r,n,s,a,o,u,l].filter(function(e){return void 0!==e}),(l=console)[h].apply(l,["["+e+"]:"].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(u))))}})}var Fe=f.LOADER_EVENTS,Ge=f.REMUX_EVENTS,Ne=f.DEMUX_EVENTS,je=f.HLS_EVENTS,Ve=f.CRYTO_EVENTS,He=f.MSE_EVENTS,Xe=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,Ye=(n(ze,[{key:"init",value:function(){var e=this._player.hlsOps,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.RemuxedBufferManager,s=e.Compatibility,a=e.FetchLoader,o=e.TsDemuxer,u=e.Mp4Remuxer,e=e.Mse;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._context.registry("TRACKS",i),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0}),this._context.registry("PRE_SOURCE_BUFFER",n),this._context.registry("COMPATIBILITY",s),this._m3u8loader=this._context.registry("M3U8_LOADER",a)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",a)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",o)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",u),this.mse=this._context.registry("MSE",e)({container:this.container}),this.initEvents()}},{key:"initEvents",value:function(){this.on(Fe.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(Fe.LOADER_RETRY,this._handleFetchRetry.bind(this)),this.on(Ge.INIT_SEGMENT,this.mse.addSourceBuffers.bind(this.mse)),this.on(Ge.MEDIA_SEGMENT,this.mse.doAppend.bind(this.mse)),this.on(Ne.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(Ne.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(Ne.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(Fe.LOADER_ERROR,this._onLoadError.bind(this)),this.on(Ne.DEMUX_ERROR,this._onDemuxError.bind(this)),this.on(Ge.REMUX_ERROR,this._onRemuxError.bind(this)),this.on(He.MSE_ERROR,this._handleMseError.bind(this))}},{key:"_onError",value:function(e,t,i,r){r={code:i.code,errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",r)}},{key:"_onDemuxComplete",value:function(){this.emit(Ge.REMUX_MEDIA,"ts")}},{key:"_onMetadataParsed",value:function(e){"video"===e&&(this._context.mediaInfo.hasVideo=!0),"audio"===e&&(this._context.mediaInfo.hasAudio=!0),this.emit(Ge.REMUX_METADATA,e)}},{key:"_onLoadError",value:function(e,t){!this._tsloader.loading&&!this._m3u8loader.loading&&1<=this.retrytimes?(this.retrytimes--,this._onError(Fe.LOADER_ERROR,e,t,!1)):this.retrytimes<=1&&(this._player.emit("error",{code:t.code,errorType:"network",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Fe.LOADER_ERROR,e,t,!0),this.emit(je.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{code:t.code,errorType:"network",ex:"["+e+"]: "+(t?t.message:""),errd:{}}),this._onError(Fe.LOADER_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Ge.REMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{errorType:"format",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(He.MSE_ERROR,e,t,i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){if("M3U8_BUFFER"===e.TAG){var t,i=void 0;try{this.m3u8Text=e.shift();var r=Xe.exec(this.m3u8Text);r&&r[2]?this.load(r[2]):i=this._player.hlsOps.M3U8Parser.parse(this.m3u8Text,this.url)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(i){try{this._playlist.pushM3U8(i,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key?(t=this._player.hlsOps.XgBuffer,this._context.registry("DECRYPT_BUFFER",t)(),this._context.registry("KEY_BUFFER",t)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",xe)({buffer:"KEY_BUFFER",readtype:3}),t=(r=this._player.config.retry||{}).count,r=r.delay,this.emitTo("KEY_LOADER",Fe.LADER_START,this._playlist.encrypt.uri,{},t,r)):this._m3u8Loaded(i)}else 0<this.retrytimes?(this.retrytimes--,this._preload()):(this.emit(je.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}else"TS_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emit(Ne.DEMUX_START)):"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",Ve.START_DECRYPT)):"KEY_BUFFER"===e.TAG&&(this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",ve)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(Ve.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_handleFetchRetry",value:function(e,t){this._player.emit("retry",Object.assign({tag:e},t))}},{key:"_onDcripted",value:function(){this.emit(Ne.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.preloadTime||(this.preloadTime=this._playlist.targetduration||5),0<this._playlist.fragLength&&this._playlist.sequence<e.sequence?this.retrytimes=this.configs.retrytimes||3:0<this.retrytimes?(this.retrytimes--,this._preload()):(this.emit(je.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_checkStatus",value:function(){var e,t;this.retrytimes<1&&Date.now()-this._lastCheck<4e3||(this.retrytimes<1&&clearInterval(this._timmer),this._lastCheck=(new Date).getTime(),this.container.buffered.length<1?this._preload():(e=this.container.currentTime,t=this.container.buffered.start(this.container.buffered.length-1),this.container.readyState<=2&&(e<t?e=this.container.currentTime=t:this._preload()),e<(t=this.container.buffered.end(this.container.buffered.length-1))-2*this.preloadTime&&(this.container.currentTime=t-this.preloadTime),e>t-this.preloadTime&&this._preload()))}},{key:"_preload",value:function(){var e,t,i,r,n;this._tsloader.loading||this._m3u8loader.loading||(e=this._playlist.getTs(),t=(n=this._player.config.retry||{}).count,i=n.delay,!e||e.downloaded||e.downloading?(r=this.preloadTime||0,n=(new Date).getTime(),(!e||e.downloaded)&&(n-this._m3u8lasttime)/1e3>r&&(this._m3u8lasttime=n,this.emitTo("M3U8_LOADER",Fe.LADER_START,this.url,{},t,i))):(this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",Fe.LADER_START,e.url,{},t,i)))}},{key:"load",value:function(e){this.url=e,this._preload()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(Fe.LOADER_COMPLETE,this._onLoadComplete),this.off(Ge.INIT_SEGMENT,this.mse.addSourceBuffers),this.off(Ge.MEDIA_SEGMENT,this.mse.doAppend),this.off(Ne.METADATA_PARSED,this._onMetadataParsed),this.off(Ne.DEMUX_COMPLETE,this._onDemuxComplete),this.mse=null,this.m3u8Text=null}}]),ze);function We(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ze(e){!function(e){if(!(e instanceof ze))throw new TypeError("Cannot call a class as a function")}(this),this.configs=Object.assign({},e),this.url="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.preloadTime=this.configs.preloadTime,this.container=this.configs.container,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),300),this._lastCheck=0,this.m3u8Text=null}var Ke=(function(e,t,i){return t&&We(e.prototype,t),i&&We(e,i),e}(Ze,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),Ze);function qe(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ze(){!function(e){if(!(e instanceof Ze))throw new TypeError("Cannot call a class as a function")}(this)}var Qe=(function(e,t,i){return t&&qe(e.prototype,t),i&&qe(e,i),e}($e,null,[{key:"isHeader",value:function(e,t){return!!(t+1<e.length&&$e.isHeaderPattern(e,t))}},{key:"getFrameDuration",value:function(e){return 9216e4/e}},{key:"isHeaderPattern",value:function(e,t){return 255===e[t]&&240==(246&e[t+1])}},{key:"getHeaderLength",value:function(e,t){return 1&e[t+1]?7:9}},{key:"getFullFrameLength",value:function(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}},{key:"parseFrameHeader",value:function(e,t,i,r,n){var s=e.length,a=$e.getHeaderLength(e,t),o=$e.getFullFrameLength(e,t);if(0<(o-=a)&&t+a+o<=s)return{headerLength:a,frameLength:o,stamp:i+r*n}}},{key:"appendFrame",value:function(e,t,i,r,n){e=$e.getFrameDuration(e),r=$e.parseFrameHeader(t,i,r,n,e);if(r){n=r.stamp,e=r.headerLength,r=r.frameLength;return{sample:{unit:t.subarray(i+e,i+e+r),pts:n,dts:n},length:r+e}}}}]),$e);function Je(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $e(){!function(e){if(!(e instanceof $e))throw new TypeError("Cannot call a class as a function")}(this)}var et=(function(e,t,i){return t&&Je(e.prototype,t),i&&Je(e,i),e}(it,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),e=new Uint8Array(4);e.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(e.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(32<e)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,0<this._currentWordBitsLeft?this._currentWord<<=t:0<this._totalBytes-this._bufferIndex&&this._fillCurrentWord(),0<(t=e-t)&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){for(var e=void 0,e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),it);function tt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function it(e){!function(e){if(!(e instanceof it))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="Golomb",this._buffer=e,this._bufferIndex=0,this._totalBytes=e.byteLength,this._totalBits=8*e.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var rt=(function(e,t,i){return t&&tt(e.prototype,t),i&&tt(e,i),e}(st,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,s=0;s<i;s++)2<=s&&3===t[s]&&0===t[s-1]&&0===t[s-2]||(r[n]=t[s],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(e){var t=st._ebsp2rbsp(e),i=new et(t);i.readByte();var r=i.readByte();i.readByte();var n=i.readByte();i.readUEG();var s=st.getProfileString(r),a=st.getLevelString(n),o=1,u=420,l=8;if((100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||144===r)&&(3===(o=i.readUEG())&&i.readBits(1),o<=3&&(u=[0,420,422,444][o]),l=i.readUEG()+8,i.readUEG(),i.readBits(1),i.readBool()))for(var h=3!==o?8:12,c=0;c<h;c++)i.readBool()&&st._skipScalingList(i,c<6?16:64);i.readUEG();var d=i.readUEG();if(0===d)i.readUEG();else if(1===d){i.readBits(1),i.readSEG(),i.readSEG();for(var f=i.readUEG(),p=0;p<f;p++)i.readSEG()}i.readUEG(),i.readBits(1);var y=i.readUEG(),_=i.readUEG(),v=i.readBits(1);0===v&&i.readBits(1),i.readBits(1);var m=0,g=0,E=0,b=0;i.readBool()&&(m=i.readUEG(),g=i.readUEG(),E=i.readUEG(),b=i.readUEG());var T=1,e=1,t=0,n=!0,r=0,d=0;i.readBool()&&(i.readBool()&&(0<(k=i.readByte())&&k<16?(T=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][k-1],e=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][k-1]):255===k&&(T=i.readByte()<<8|i.readByte(),e=i.readByte()<<8|i.readByte())),i.readBool()&&i.readBool(),i.readBool()&&(i.readBits(4),i.readBool()&&i.readBits(24)),i.readBool()&&(i.readUEG(),i.readUEG()),i.readBool()&&(A=i.readBits(32),S=i.readBits(32),n=i.readBool(),t=(r=S)/(d=2*A)));var k=1;1===T&&1===e||(k=T/e);var S=0,A=0,A=0===o?(S=1,2-v):(S=3===o?1:2,(1===o?2:1)*(2-v)),y=16*(y+1),v=16*(_+1)*(2-v);y-=(m+g)*S,v-=(E+b)*A;k=Math.ceil(y*k);return i.destroy(),i=null,{profile_string:s,level_string:a,bit_depth:l,chroma_format:u,chroma_format_string:st.getChromaFormatString(u),frame_rate:{fixed:n,fps:t,fps_den:d,fps_num:r},par_ratio:{width:T,height:e},codec_size:{width:y,height:v},present_size:{width:k,height:v}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)i=0===(r=0!==r?(i+e.readSEG()+256)%256:r)?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,e=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/e)),t}}]),st);function nt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function st(){!function(e){if(!(e instanceof st))throw new TypeError("Cannot call a class as a function")}(this)}var at=(function(e,t,i){return t&&nt(e.prototype,t),i&&nt(e,i),e}(ut,null,[{key:"EBSP2RBSP",value:function(i){return i.filter(function(e,t){return t<2||!(0===i[t-2]&&0===i[t-1]&&3===e)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),ut);function ot(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ut(){!function(e){if(!(e instanceof ut))throw new TypeError("Cannot call a class as a function")}(this)}function lt(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t}var ht=(function(e,t,i){return t&&ot(e.prototype,t),i&&ot(e,i),e}(dt,null,[{key:"_resolveNalu",value:function(e){return 1<=e.length?at.EBSP2SODB(at.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(e){var t=dt._resolveNalu(e),i=dt.switchPayloadType(t),e=i.payloadType,i=i.offset,i=t.slice(i);return 5!==e?{code:e,content:i}:dt.user_data_unregistered(i)}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(e){var t=dt.getPayloadLength(e),i=t.payloadLength,t=t.offset;if(i<16)return{uuid:"",content:null};t=e.slice(t);return{code:5,uuid:lt(t.slice(0,16)),content:lt(t.slice(16,i))}}}]),dt);function ct(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function dt(){!function(e){if(!(e instanceof dt))throw new TypeError("Cannot call a class as a function")}(this)}(function(e,t,i){t&&ct(e.prototype,t),i&&ct(e,i)})(pt,null,[{key:"getNalunits",value:function(e){if(e.length-e.position<4)return[];var t=e.dataview,i=e.position;return 1===t.getInt32(i)||0===t.getInt16(i)&&1===t.getInt8(i+2)?pt.getAnnexbNals(e):pt.getAvccNals(e)}},{key:"getAnnexbNals",value:function(e){for(var t=[],i=pt.getHeaderPositionAnnexB(e),r=i.pos;r<e.length-4;){var n=e.buffer.slice(r,r+i.headerLength);i.pos===e.position&&e.skip(i.headerLength);var s=(i=pt.getHeaderPositionAnnexB(e)).pos,n={header:n,body:new Uint8Array(e.buffer.slice(r+n.byteLength,s))};pt.analyseNal(n),n.type<=9&&0!==n.type&&t.push(n),e.skip(s-e.position),r=s}return t}},{key:"getAvccNals",value:function(e){for(var t=[];e.position<e.length-4;){var i=e.dataview.getInt32(e.dataview.position);if(!(e.length-e.position>=i))break;var r=e.buffer.slice(e.position,e.position+4);e.skip(4);var n=new Uint8Array(e.buffer.slice(e.position,e.position+i));e.skip(i);n={header:r,body:n};pt.analyseNal(n),n.type<=9&&0!==n.type&&t.push(n)}return t}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:try{e.sei=ht.parse(e.body)}catch(e){}break;case 7:e.sps=rt.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=r:0===e.dataview.getInt16(++t)&&1===e.dataview.getInt8(t)?i=3:t=r),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),6),r+=2,i.set(e,8),i[r+=e.byteLength]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),i.set(t,r+=2),i}}]),r=pt;function ft(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pt(){!function(e){if(!(e instanceof pt))throw new TypeError("Cannot call a class as a function")}(this)}var yt=(function(e,t,i){return t&&ft(e.prototype,t),i&&ft(e,i),e}(vt,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),e=new Uint8Array(4);e.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(e.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(32<e)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,0<this._currentWordBitsLeft?this._currentWord<<=t:0<this._totalBytes-this._bufferIndex&&this._fillCurrentWord(),0<(t=e-t)&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){for(var e=void 0,e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),vt);function _t(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vt(e){!function(e){if(!(e instanceof vt))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="Golomb",this._buffer=e,this._bufferIndex=0,this._totalBytes=e.byteLength,this._totalBits=8*e.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var mt=(function(e,t,i){return t&&_t(e.prototype,t),i&&_t(e,i),e}(Et,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,s=0;s<i;s++)2<=s&&3===t[s]&&0===t[s-1]&&0===t[s-2]||(r[n]=t[s],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(e){var t,i,r,n,s,a=Et._ebsp2rbsp(e),o=new yt(a),u=0,l=0,h=0,c=0,d=0,f=0,p=0;return o.readByte(),o.readByte(),o.readBits(4),i=o.readBits(3),o.readBits(1),r=Et._readProfileTierLevel(o,i),o.readUEG(),3===(t=o.readUEG())&&(u=o.readBits(1)),l=o.readUEG(),h=o.readUEG(),1===(e=o.readBits(1))&&(c=o.readUEG(),d=o.readUEG(),f=o.readUEG(),p=o.readUEG()),a=o.readUEG(),i=o.readUEG(),1===e&&(l-=(n=1!==t&&2!==t||0!==u?1:2)*d+n*c,h-=(s=1===t&&0===u?2:1)*p+s*f),o.destroy(),o=null,{width:l,height:h,general_profile_space:r.general_profile_space,general_tier_flag:r.general_tier_flag,general_profile_idc:r.general_profile_idc,general_level_idc:r.general_level_idc,chromaFormatIdc:t,bitDepthLumaMinus8:a,bitDepthChromaMinus8:i}}},{key:"_readProfileTierLevel",value:function(e,t){var i=e.readBits(2)||0,r=e.readBits(1)||0,n=e.readBits(5)||0;e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12);for(var s=e.readBits(8)||0,a=[],o=[],u=0;u<t;u++)a[u]=e.readBits(1),o[u]=e.readBits(1);0<t&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==a[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:r,general_profile_idc:n,general_level_idc:s}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)i=0===(r=0!==r?(i+e.readSEG()+256)%256:r)?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}]),Et);function gt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Et(){!function(e){if(!(e instanceof Et))throw new TypeError("Cannot call a class as a function")}(this)}var bt=(function(e,t,i){return t&&gt(e.prototype,t),i&&gt(e,i),e}(kt,null,[{key:"EBSP2RBSP",value:function(i){return i.filter(function(e,t){return t<2||!(0===i[t-2]&&0===i[t-1]&&3===e)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),kt);function Tt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function kt(){!function(e){if(!(e instanceof kt))throw new TypeError("Cannot call a class as a function")}(this)}function St(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t}var At=(function(e,t,i){return t&&Tt(e.prototype,t),i&&Tt(e,i),e}(Rt,null,[{key:"_resolveNalu",value:function(e){return 1<=e.length?bt.EBSP2SODB(bt.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(e){var t=Rt._resolveNalu(e),i=Rt.switchPayloadType(t),e=i.payloadType,i=i.offset,i=t.slice(i);return 5!==e?{code:e,content:i}:Rt.user_data_unregistered(i)}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(e){var t=Rt.getPayloadLength(e),i=t.payloadLength,t=t.offset;if(i<16)return{uuid:"",content:null};t=e.slice(t);return{code:5,uuid:St(t.slice(0,16)),content:St(t.slice(16,i))}}}]),Rt);function Dt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Rt(){!function(e){if(!(e instanceof Rt))throw new TypeError("Cannot call a class as a function")}(this)}(function(e,t,i){t&&Dt(e.prototype,t),i&&Dt(e,i)})(Ot,null,[{key:"getNalunits",value:function(e){if(e.length-e.position<4)return[];var t=e.dataview,i=e.position;return 1===t.getInt32(i)||0===t.getInt16(i)&&1===t.getInt8(i+2)?Ot.getAnnexbNals(e):Ot.getHvccNals(e)}},{key:"getAnnexbNals",value:function(e){for(var t=[],i=Ot.getHeaderPositionAnnexB(e),r=i.pos;r<e.length-4;){var n=e.buffer.slice(r,r+i.headerLength);i.pos===e.position&&e.skip(i.headerLength);var s=(i=Ot.getHeaderPositionAnnexB(e)).pos,n={header:n,body:new Uint8Array(e.buffer.slice(r+n.byteLength,s))};Ot.analyseNal(n),n.type<=40&&t.push(n),e.skip(s-e.position),r=s}return t}},{key:"getHvccNals",value:function(e){for(var t=[];e.position<e.length-4;){var i=e.dataview.getInt32(e.dataview.position);if(!(e.length-e.position>=i))break;var r=e.buffer.slice(e.position,e.position+4);e.skip(4);var n=new Uint8Array(e.buffer.slice(e.position,e.position+i));e.skip(i);n={header:r,body:n};try{Ot.analyseNal(n)}catch(e){continue}n.type<=40&&t.push(n)}return t}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0,e.key=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=mt.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:try{e.sei=At.parse(e.body.slice(1))}catch(e){}break;case 40:e.sei=At.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):0===e.dataview.getInt16(++t)&&1===e.dataview.getInt8(t)?i=3:t=r),{pos:t,headerLength:i}}}]),u=Ot,s=function(e,t,i){return t&&wt(e.prototype,t),i&&wt(e,i),e};function wt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ot(){!function(e){if(!(e instanceof Ot))throw new TypeError("Cannot call a class as a function")}(this)}function Lt(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}var xt=f.REMUX_EVENTS,Ut=(s(Pt,[{key:"init",value:function(){this.before(xt.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"_isSegmentsContinuous",value:function(){return 0===this._lastSegmentId||this._currentSegmentId-this._lastSegmentId==1}},{key:"doFix",value:function(){var e=void 0,t=void 0,i=void 0,r=0;this.videoTrack.samples.length&&(e=(t=this.videoTrack.samples[0]).options,Be.long&&Be.log(this.TAG,this.videoTrack.samples.slice())),this.audioTrack.samples.length&&(i=this.audioTrack.samples[0],Be.long&&Be.log(this.TAG,this.audioTrack.samples.slice())),t&&i&&(r=i.dts-t.dts),this._currentSegmentId=e&&e.id||this._currentSegmentId+1,Be.log(this.TAG,"lastSeg:"+this._lastSegmentId+" , currentSeg:"+this._currentSegmentId+", discontinue:"+(e&&e.discontinue)+" vSamp0:"+(t&&t.dts)+" aSamp0:"+(i&&i.dts));var t=this.getFirstSample(),n=t.isFirstAudioSamples,s=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var i=Pt.detectChangeStream(this.videoTrack.samples,s),t=i.changed,a=i.changedIdxes;if(t){for(var o=!1,u=0;u<a.length;u++)this.fixChangeStreamVideo(a[u],s)&&(o=!0);o||this.doFixVideo(s)}else!this._isSegmentsContinuous()&&e&&void 0!==e.start?(this.videoLastSample=null,l=e.start,r<0&&(l-=r),Be.log(this.TAG,"fix video for _isSegmentsContinuous()， delta:",r),this.doFixVideo(s,l),this.emit(xt.DETECT_FRAG_ID_DISCONTINUE,e.start/1e3)):this.doFixVideo(s);this._appendSampleForLastSegment(e&&e.isLast);var r=Pt.detectChangeStream(this.audioTrack.samples,n),l=r.changed,h=r.changedIdxes;if(l){for(var c=!1,d=0;d<h.length;d++)this.fixChangeStreamAudio(h[d],n)&&(c=!0);if(c)return;this.doFixAudio(n)}else!this._isSegmentsContinuous()&&e&&void 0!==e.start?(Be.log(this.TAG,"fix audio for _isSegmentsContinuous()"),l=this.audioTrack.samples[0],this.nextAudioDts=e.start||l&&l.dts,this.doFixAudio(n,e.start),this.emit(xt.DETECT_FRAG_ID_DISCONTINUE,e.start/1e3)):this.doFixAudio(n);this.removeInvalidSamples(),this._lastSegmentId=this._currentSegmentId}},{key:"doFixVideo",value:function(e,t){for(var i=this.videoTrack,r=i.samples,n=i.meta,s=r.length,a=0;a<s;a++){var o=r[a];o.originDts=o.dts,o.originPts=o.pts}if(r&&s&&this._firstVideoSample){var u=r[0];if(Be.log(this.TAG,"doFixVideo:: lastVideoDts: "+this.lastVideoDts+" ,  _videoLargeGap: "+this._videoLargeGap+" ,streamChangeStart:"+t+", lastVideoSample:[dts="+(this.videoLastSample&&this.videoLastSample.dts)+" , pts="+(this.videoLastSample&&this.videoLastSample.pts)+"] ,  firstDTS:"+u.dts+" ,firstPTS:"+u.pts+" ,lastDTS:"+r[s-1].dts+" , lastPTS: "+r[s-1].pts),!e&&void 0===t&&this.videoLastSample&&Pt.detectVideoLargeGap(this.videoLastSample?this.videoLastSample.dts:0,u.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+n.refSampleDuration-u.dts),0!==this._videoLargeGap&&(Pt.doFixLargeGap(r,this._videoLargeGap),this._videoLargeGap!==this.preVideoGap&&(this.preVideoGap=this._videoLargeGap,this.emit(xt.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:this.videoLastSample&&this.videoLastSample.originDts,curDts:u.originDts}))),e||void 0===t||0===t||(this._videoLargeGap=t-u.dts,Pt.doFixLargeGap(r,this._videoLargeGap)),e&&this._firstAudioSample){var l=this._firstVideoSample.originDts,h=l-this._firstAudioSample.dts;if(h>2*n.refSampleDuration&&h<10*n.refSampleDuration){for(var c=Math.floor(h/n.refSampleDuration),d=0;d<c;d++){var f=Object.assign({},u);f.dts=l-(d+1)*n.refSampleDuration,f.pts=f.dts+f.cts,r.unshift(f),this.filledVideoSamples.push({dts:f.dts,size:f.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(h)>2*n.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*h,Pt.doFixLargeGap(r,-1*h))}for(var p=r.length,y=1;y<p;y++){var _=r[y],v=r[y-1],m=_.dts-_.pts;Math.abs(m)<2e3&&1e4<Math.abs(_.dts-v.dts)&&(_.dts=v.dts+n.refSampleDuration,_.pts=v.pts+n.refSampleDuration)}e=r.pop();if(r.length&&(r[r.length-1].duration=e.dts-r[r.length-1].dts),p<4){var g,E=(g=(g=r[r.length-1])||e).options&&g.options.duration,b=n.refSampleDuration;if(E&&b&&5<E/b)for(var T=g.pts,k=g.dts,S=0;S<3;S++){k+=b,T+=b;var A=Object.assign({},g,{dts:k,pts:T});2===S&&(A.duration=E),r.push(A)}e=null}this.videoLastSample&&((h=this.videoLastSample).duration=u.dts-h.dts,r.unshift(this.videoLastSample)),this.videoLastSample=e,r[r.length-1]&&(this.lastVideoDts=r[r.length-1].dts),this.videoTrack.samples=r}}},{key:"_appendSampleForLastSegment",value:function(e){e&&this.videoLastSample&&this.videoTrack.samples.push(this.videoLastSample)}},{key:"doFixAudio",value:function(e,t){var i=this,r=this.audioTrack,n=r.samples,s=r.meta;if(n&&n.length){this.fixAudioRefSampleDuration(s);for(var a=0,o=n.length;a<o;a++){var u=n[a];u.originDts=u.dts}var l=n.length,h=Ke.getSilentFrame(s.originCodec,s.channelCount),c=Math.floor(s.refSampleDuration),d=this._firstAudioSample,f=n[0];if(Be.log(this.TAG,"doFixAudio:: audioDtsBase:"+this.audioDtsBase+" ,  _audioLargeGap: "+this._audioLargeGap+", streamChangeStart:"+t+" ,  nextAudioDts:"+this.nextAudioDts+",  audio: firstDTS:"+f.dts+" ,firstPTS:"+f.pts+" ,lastDTS:"+n[l-1].dts+" , lastPTS: "+n[l-1].pts),!e&&null===this.nextAudioDts&&f.options&&f.options.start&&void 0!==t&&(t=f.options.start),!e&&void 0===t&&this.nextAudioDts&&Pt.detectAudioLargeGap(this.nextAudioDts||0,f.dts+this._audioLargeGap)&&(r=this.nextAudioDts-f.dts,this._audioLargeGap=Math.abs(r-this._videoLargeGap)<200?this._videoLargeGap:r),0!==this._audioLargeGap?(Pt.doFixLargeGap(n,this._audioLargeGap),this._audioLargeGap!==this.preAudioGap&&(this.preAudioGap=this._audioLargeGap,this.emit(xt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:this.lastAudioOriginDts,curDts:f.originDts}))):e||void 0===t&&!Pt.detectAudioLargeGap(this.nextAudioDts,f.dts)||(void 0!==t&&0!==t&&(this.nextAudioDts=t),this._audioLargeGap=this.nextAudioDts-f.dts,f.options.start&&!f.options.start.isContinue&&Pt.doFixLargeGap(n,this._audioLargeGap)),this._firstVideoSample&&e){var e=this._firstVideoSample.originDts||this._firstVideoSample.dts,p=d.dts-e;if(p!==this._videoLargeGap)if(p>s.refSampleDuration&&p<10*s.refSampleDuration){var y=Math.floor((d.dts-e)/s.refSampleDuration);Be.warn(this.TAG,"fill "+y+" frames for av align");for(var _=0;_<y;_++){var v={data:h,datasize:h.byteLength,dts:d.dts-(_+1)*s.refSampleDuration,filtered:0};n.unshift(v),this.filledAudioSamples.push({dts:v.dts,size:v.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else p<-1*s.refSampleDuration&&(this._audioLargeGap=-1*p,Pt.doFixLargeGap(n,-1*p))}var m=n[0].dts;if(this.nextAudioDts){var p=m-this.nextAudioDts,g=Math.abs(p);if(c<=p&&p<1e4&&h){for(var E=Math.ceil(p/c),b=0;b<E;b++){var T=m-(b+1)*c,T={dts:T>this.nextAudioDts?T:this.nextAudioDts,pts:T>this.nextAudioDts?T:this.nextAudioDts,datasize:h.byteLength,filtered:0,data:h};this.filledAudioSamples.push({dts:T.dts,size:T.data.byteLength}),this.audioTrack.samples.unshift(T),f=T}this.emit(xt.DETECT_AUDIO_GAP,p,E)}else g<s.refSampleDuration&&0<g?(f.dts=this.nextAudioDts,f.pts=this.nextAudioDts):p<0&&g<c&&(Pt.doFixLargeGap(n,-1*p),this.emit(xt.DETECT_AUDIO_OVERLAP,p))}for(var k=n[0].dts+c,S=1;S<n.length;){var A=n[S],D=A.dts-k;if(D<=-1*c)Be.warn("drop 1 audio sample for "+D+" ms overlap"),n.splice(S,1);else if(10*c<=D){var R=Math.round(D/c);if(1e3<R)break;Be.warn(this.TAG,"inject "+R+" audio frame for "+D+" ms gap, index="+S);for(var w=0;w<R;w++){var O={data:h,datasize:h.byteLength,dts:k,originDts:k,filtered:0};n.splice(S,0,O),k+=c,S++}A.dts=A.pts=A.originDts=k,k+=c,S++}else A.dts=A.pts=A.originDts=k,k+=c,S++}var L=s.refSampleDuration-c;n.forEach(function(e,t){0!==t&&(t=n[t-1],e.dts=e.pts=t.dts+t.duration),e.duration=c,i.audioUnsyncTime=i.audioUnsyncTime+L,1<=i.audioUnsyncTime&&(e.duration+=1,--i.audioUnsyncTime)});g=n[n.length-1];this.lastAudioDts=g.dts;p=g.duration;this.lastAudioSamplesLen=l,this.nextAudioDts=this.lastAudioDts+(p||c),this.lastAudioOriginDts=g.originDts,this.audioTrack.samples=Pt.sortAudioSamples(n)}}},{key:"fixChangeStreamVideo",value:function(e){Be.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack.samples,i=0===e?this.lastVideoDts||this.getStreamChangeStart(t[0]):t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(xt.DETECT_CHANGE_STREAM,"video",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(xt.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:i,curDts:r});var s=t.slice(0,e),a=t.slice(e),n=t[e];return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,r=n.options&&void 0!==n.options.start?n.options.start:i-this.videoDtsBase,this.videoTrack.samples=t.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=t.slice(e),this.doFixVideo(!1,r),this.videoTrack.samples=s.concat(a),!0}},{key:"fixChangeStreamAudio",value:function(e){Be.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack.samples,i=0===e?this.lastAudioDts:t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(xt.DETECT_CHANGE_STREAM,"audio",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(xt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:i,curDts:r}),this._audioLargeGap=0;n=this.nextAudioDts;this.nextAudioDts=null;i=t.slice(0,e),r=t.slice(e),t=t[e],e=void 0;return t.options&&void 0!==t.options.start?e=t.options.start:(e=n,t.options.isContinue=!0),this.audioTrack.samples=i,this.doFixAudio(!1),this.audioTrack.samples=r,this.doFixAudio(!1,e),this.audioTrack.samples=i.concat(r),!0}},{key:"getFirstSample",value:function(){var e=this.videoTrack.samples,t=this.audioTrack.samples,i=!1,r=!1;return!this._firstVideoSample&&e.length&&(this._firstVideoSample=Pt.findFirstVideoSample(e),this.removeInvalidSamples(),i=!0),!this._firstAudioSample&&t.length&&(this._firstAudioSample=Pt.findFirstAudioSample(t),this.removeInvalidSamples(),r=!0),{isFirstVideoSamples:i,isFirstAudioSamples:r}}},{key:"fixVideoRefSampleDuration",value:function(e,t){var i,r,n,s;e&&(i=this.allVideoSamplesCount,r=this._firstVideoSample.dts,s=this.filledVideoSamples.length,Pt.isRefSampleDurationValid(e.refSampleDuration)?e.refSampleDuration&&5<=t.length&&(0<(n=(t[t.length-1].dts-t[0].dts)/(t.length-1))&&n<1e3&&(n=Math.floor(Math.abs(e.refSampleDuration-n)<=5?e.refSampleDuration:n),Pt.isRefSampleDurationValid(n)&&(e.refSampleDuration=n))):1<=t.length&&(t=t[t.length-1].dts,s=Math.floor((t-r)/(i+s-1)),Pt.isRefSampleDurationValid(s)&&(e.refSampleDuration=s)),Pt.isRefSampleDurationValid(e.refSampleDuration)||(e.refSampleDuration=66))}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var i=this.audioTrack.samples[0],r=this.videoTrack.samples[0];i&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(e,t){return e===i||e.dts>=i.dts})),r&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(e,t){return e===r||e.dts>=r.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:[].concat(Lt(e)).sort(function(e,t){return e.dts-t.dts})}},{key:"isRefSampleDurationValid",value:function(e){return e&&0<e&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(e){return e&&0!==e.length?Pt.sortAudioSamples(e)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=[].concat(Lt(e)).sort(function(e,t){return e.dts-t.dts}),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t){if(null!==e)return 1e3<=e-t||1e3<=t-e}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return 1e3<=e-t||1e3<=t-e}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}var s=e[0];s&&0===s.dts&&(s.dts=s.pts=1)}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,r=[],n=0,s=e.length;n<s;n++){var a=e[n];!a.options||!a.options.meta||t&&0===n||(i=!0,r.push(n))}return{changed:i,changedIdxes:r}}}]),Pt),n=se(function(e){var r=Object.prototype.hasOwnProperty,f="~";function i(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,i,r,n){if("function"!=typeof i)throw new TypeError("The listener must be a function");n=new s(i,r||e,n),t=f?f+t:t;return e._events[t]?e._events[t].fn?e._events[t]=[e._events[t],n]:e._events[t].push(n):(e._events[t]=n,e._eventsCount++),e}function u(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function t(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(f=!1)),t.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(f?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},t.prototype.listeners=function(e){var e=f?f+e:e,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var i=0,r=t.length,n=new Array(r);i<r;i++)n[i]=t[i].fn;return n},t.prototype.listenerCount=function(e){e=f?f+e:e,e=this._events[e];return e?e.fn?1:e.length:0},t.prototype.emit=function(e,t,i,r,n,s){var a=f?f+e:e;if(!this._events[a])return!1;var o,u=this._events[a],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,i),!0;case 4:return u.fn.call(u.context,t,i,r),!0;case 5:return u.fn.call(u.context,t,i,r,n),!0;case 6:return u.fn.call(u.context,t,i,r,n,s),!0}for(d=1,o=new Array(l-1);d<l;d++)o[d-1]=arguments[d];u.fn.apply(u.context,o)}else for(var h,c=u.length,d=0;d<c;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),l){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,i);break;case 4:u[d].fn.call(u[d].context,t,i,r);break;default:if(!o)for(h=1,o=new Array(l-1);h<l;h++)o[h-1]=arguments[h];u[d].fn.apply(u[d].context,o)}return!0},t.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},t.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},t.prototype.removeListener=function(e,t,i,r){e=f?f+e:e;if(!this._events[e])return this;if(!t)return u(this,e),this;var n=this._events[e];if(n.fn)n.fn!==t||r&&!n.once||i&&n.context!==i||u(this,e);else{for(var s=0,a=[],o=n.length;s<o;s++)(n[s].fn!==t||r&&!n[s].once||i&&n[s].context!==i)&&a.push(n[s]);a.length?this._events[e]=1===a.length?a[0]:a:u(this,e)}return this},t.prototype.removeAllListeners=function(e){return e?(e=f?f+e:e,this._events[e]&&u(this,e)):(this._events=new i,this._eventsCount=0),this},t.prototype.off=t.prototype.removeListener,t.prototype.addListener=t.prototype.on,t.prefixed=f,e.exports=t.EventEmitter=t}),Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ct="function"==typeof Symbol&&"symbol"===Mt(Symbol.iterator)?function(e){return void 0===e?"undefined":Mt(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Mt(e)},s=function(e,t,i){return t&&Bt(e.prototype,t),i&&Bt(e,i),e};function Bt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Pt(){var t=this;!function(e){if(!(e instanceof Pt))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this._lastSegmentId=0,this._currentSegmentId=0,this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){0!==(t.___videoLargeGap=e)&&t.emit(xt.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){0!==(t.___audioLargeGap=e)&&t.emit(xt.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}var It=r,Ft=u,Gt={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],36:["video","HVC.H265"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},Nt=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Mt(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(Vt,n),s(Vt,null,[{key:"EVENTS",get:function(){return{DEMUX_COMPLETE:"DEMUX_COMPLETE",METADATA_PARSED:"METADATA_PARSED",VIDEO_SAMPLE_PARSED:"VIDEO_SAMPLE_PARSED",AUDIO_SAMPLE_PARSED:"AUDIO_SAMPLES_PARSED",SEI_PARSED:"SEI_PARSED"}}}]),s(Vt,[{key:"demux",value:function(e,t,i){if(e&&Be.log(this.TAG,"do demux: id="+e.id+",demuxing="+this.demuxing),!this.demuxing){for(var r,n,s={pat:[],pmt:[]},a={};188<=t.length;){if(1<=t.length&&71!==t.array[0][t.offset])throw new Error("Untrust sync code: "+t.array[0][t.offset]+", try to recover;");for(;1<=t.length&&71!==t.array[0][t.offset];)t.shift(1);t.length<188||(r=t.shift(188),n=new k(r.buffer),Vt.read(n,r={},s),n=a[r.header.pid],r.pes?(r.pes.codec=r.header.codec,r.pes.streamType=r.header.streamType,a[r.header.pid]||(a[r.header.pid]=[]),a[r.header.pid].push(r.pes),r.pes.ES.buffer=[r.pes.ES.buffer]):n&&n[n.length-1].ES.buffer.push(r.payload.stream))}for(var o=Object.assign({},e),u=Object.assign({},e),l=i&&this._hasVideoMeta&&!this._hasAudioMeta,h=i&&this._hasAudioMeta&&!this._hasVideoMeta,c=0;c<Object.keys(a).length;c++)for(var d=a[Object.keys(a)[c]],f=0;f<d.length;f++){var p=d[f];p.id=Object.keys(a)[c];var y=15===p.streamType||17===p.streamType;"audio"===p.type&&!l&&y?(p.ES.buffer=Vt.mergeAudioES(p.ES.buffer),this.pushAudioSample(p,o),o={}):"video"!==p.type||h||(p.ES.buffer=Vt.mergeVideoES(p.ES.buffer),"HVC.H265"===p.codec?this.pushVideoSampleHEVC(d[f],u):this.pushVideoSample(d[f],u),u={spsFound:!!u.spsFound})}}}},{key:"pushAudioSample",value:function(e,t){var i=new j({audioSampleRate:e.ES.frequence,sampleRate:e.ES.frequence,channelCount:e.ES.channel,codec:"mp4a.40."+e.ES.audioObjectType,originCodec:"mp4a.40."+e.ES.originAudioObjectType,originObjectType:e.ES.originAudioObjectType,config:e.ES.audioConfig,id:2,sampleRateIndex:e.ES.frequencyIndex});i.refSampleDuration=Math.floor(1024/i.audioSampleRate*i.timescale);var r=Vt.compareMeta(this.audioTrack.meta,i,!0);this._hasAudioMeta&&r||(this._hasAudioMeta=!0,t?t.meta=Object.assign({},i):t={meta:Object.assign({},i)},this.emit(Vt.EVENTS.METADATA_PARSED,"audio",i));var n=0;e.ES.buffer.skip(e.pesHeaderLength+9);for(var s=!1;e.ES.buffer.position<e.ES.buffer.length;)if(Qe.isHeader(new Uint8Array(e.ES.buffer.buffer),e.ES.buffer.position)&&e.ES.buffer.position+5<e.ES.buffer.length){var a=Qe.appendFrame(this.audioTrack.meta.sampleRate,new Uint8Array(e.ES.buffer.buffer),e.ES.buffer.position,e.pts,n);if(!a||!a.sample)break;e.ES.buffer.skip(a.length);a=new z({dts:a.sample.dts,pts:a.sample.pts,data:a.sample.unit,options:s?{}:t});t.meta&&(s=!0),a.dts=a.pts=Math.ceil(a.pts/90),this.emit(Vt.EVENTS.AUDIO_SAMPLE_PARSED,a),n++}else e.ES.buffer.skip(1)}},{key:"pushVideoSample",value:function(e,t){for(var i,r=this,n=It.getNalunits(e.ES.buffer),s=new V,a=t.spsFound,o=0,u=!1,l=!1,h=[],c=0;c<n.length;c++){var d=n[c];if(d.type<9&&!d.sei&&(o+=4+d.body.byteLength),d.sps){s.sps=(u=d).body,s.chromaFormat=u.sps.chroma_format,s.codec="avc1.";for(var f=1;f<4;f++){var p=u.body[f].toString(16);p.length<2&&(p="0"+p),s.codec+=p}s.codecHeight=u.sps.codec_size.height,s.codecWidth=u.sps.codec_size.width,s.frameRate=u.sps.frame_rate,s.id=1,s.level=u.sps.level_string,s.presentHeight=u.sps.present_size.height,s.presentWidth=u.sps.present_size.width,s.profile=u.sps.profile_string,s.refSampleDuration=Math.floor(s.timescale*(u.sps.frame_rate.fps_den/u.sps.frame_rate.fps_num)),s.sarRatio=u.sps.sar_ratio||u.sps.par_ratio}else d.pps?(s.pps=d.body,l=d):d.sei&&h.push(d.sei)}u&&l&&(s.avcc=It.getAvcc(u.body,l.body),i=Vt.compareMeta(this.videoTrack.meta,s,!0),this._hasVideoMeta&&i||(t?t.meta=Object.assign({},s):t={meta:Object.assign({},s)},a||this.emit(Vt.EVENTS.METADATA_PARSED,"video",s),t.spsFound=!0,this._hasVideoMeta=!0));for(var y=new Uint8Array(o),_=0,v=!1,m=0;m<n.length;m++){var g,E=n[m];E.type&&9<=E.type||(g=E.body.byteLength,E.idr&&(v=!0),E.sei||(y.set(new Uint8Array([g>>>24&255,g>>>16&255,g>>>8&255,255&g]),_),_+=4,y.set(E.body,_),_+=g))}var b=parseInt(e.dts/90),a=parseInt(e.pts/90);h.length&&h.forEach(function(e){e.dts=b,r.emit(Vt.EVENTS.SEI_PARSED,e)});t=new K({dts:b,pts:a,cts:a-b,originDts:e.dts,purePts:e.purePts,isKeyframe:v,data:y,nals:n,options:t,firstInGop:v,gopId:v?++this.gopId:this.gopId});this.emit(Vt.EVENTS.VIDEO_SAMPLE_PARSED,t)}},{key:"pushVideoSampleHEVC",value:function(e,t){for(var i=this,r=(r=Ft.getNalunits(e.ES.buffer)).filter(function(e){return e.body&&e.body.length}),n=new V,s=0,a=!(n.streamType=36),o=!1,u=!1,l=[],h=!1,c=!1,d=!1,f=!1,p=0;p<r.length;p++){var y=r[p];if(y.vps){if(h)continue;h=!0}else if(y.sps){if(c)continue;c=!0}else if(y.pps){if(d)continue;d=!0}else if(y.key)20!==y.type&&19!==y.type||(f=!0);else if(0!==y.type&&35===y.type)continue;y.sps?(n.sps=(o=y).body,n.presentWidth=o.sps.width,n.presentHeight=o.sps.height,n.general_profile_space=o.sps.general_profile_space,n.general_tier_flag=o.sps.general_tier_flag,n.general_profile_idc=o.sps.general_profile_idc,n.general_level_idc=o.sps.general_level_idc,n.codec="hev1.1.6.L93.B0",n.chromaFormatIdc=o.sps.chromaFormatIdc,n.bitDepthLumaMinus8=o.sps.bitDepthLumaMinus8,n.bitDepthChromaMinus8=o.sps.bitDepthChromaMinus8):y.pps?(n.pps=y.body,u=y):y.vps?(n.vps=y.body,a=y):y.sei&&l.push(y.sei),y.type<=40&&(s+=4+y.body.byteLength)}o&&u&&a&&(k=Vt.compareMeta(this.videoTrack.meta,n,!0),this._hasVideoMeta&&k||(t?t.meta=Object.assign({},n):t={meta:Object.assign({},n)},n.streamType=36,this.videoTrack.meta=n,this._hasVideoMeta=!0,this.emit(Vt.EVENTS.METADATA_PARSED,"video",n)));for(var _=new Uint8Array(s),v=0,m=!1,h=!1,c=!1,d=!1,g=0;g<r.length;g++){var E=r[g];if(!(E.type&&40<E.type)){if(E.vps){if(h)continue;h=!0}else if(E.sps){if(c)continue;c=!0}else if(E.pps){if(d)continue;d=!0}else if(!E.key&&0!==E.type&&35===E.type)continue;var b=E.body.byteLength;E.key&&(m=!0),_.set(new Uint8Array([b>>>24&255,b>>>16&255,b>>>8&255,255&b]),v),v+=4,_.set(E.body,v),v+=b}}var T=parseInt(e.dts/90),k=parseInt(e.pts/90);l&&l.forEach(function(e){e.dts=T,i.emit(Vt.EVENTS.SEI_PARSED,e)});t=new K({dts:T,pts:k,cts:k-T,originDts:e.dts,purePts:e.purePts,isKeyframe:m,data:_,nals:r,options:t,firstInGop:f,gopId:f?++this.gopId:this.gopId});this.emit(Vt.EVENTS.VIDEO_SAMPLE_PARSED,t)}},{key:"destroy",value:function(){this.removeAllListeners(),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}}],[{key:"compareArray",value:function(e,t,i){var r=0,n=0;if("Uint8Array"===i?(r=e.byteLength,n=t.byteLength):"Array"===i&&(r=e.length,n=t.length),r!==n)return!1;for(var s=0;s<r;s++)if(e[s]!==t[s])return!1;return!0}},{key:"compareMeta",value:function(e,t,i){if(!e||!t)return!1;for(var r=0,n=Object.keys(e).length;r<n;r++){var s=e[Object.keys(e)[r]],a=t[Object.keys(e)[r]];if(!s&&!a)return!0;if(null==s&&a||s&&void 0===a)return!1;if("object"!==(void 0===s?"undefined":Ct(s))){if(i&&"duration"!==Object.keys(e)[r]&&"refSampleDuration"!==Object.keys(e)[r]&&"refSampleDurationFixed"!==Object.keys(e)[r]&&s!==a)return!1}else if(void 0!==s.byteLength){if(void 0===a.byteLength)return!1;if(!Vt.compareArray(s,a,"Uint8Array"))return!1}else if(void 0!==s.length){if(void 0===a.length)return!1;if(!Vt.compareArray(s,a,"Array"))return!1}else if(!Vt.compareMeta(s,a))return!1}return!0}},{key:"mergeVideoES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length-e[n].position;for(var t=new Uint8Array(i),s=0;s<e.length;s++){var a=e[s];t.set(new Uint8Array(a.buffer,a.position),r),r+=a.length-a.position}return new k(t.buffer)}},{key:"mergeAudioES",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length;for(var t=new Uint8Array(i),s=0;s<e.length;s++){var a=e[s];t.set(new Uint8Array(a.buffer),r),r+=a.length}return new k(t.buffer)}},{key:"read",value:function(e,t,i){Vt.readHeader(e,t),Vt.readPayload(e,t,i),"MEDIA"!==t.header.packet||1!==t.header.payload||t.unknownPIDs||(t.pes=Vt.PES(t))}},{key:"readPayload",value:function(e,t,i){var r=t.header.pid;switch(r){case 0:Vt.PAT(e,t,i);break;case 1:Vt.CAT(e,t,i);break;case 2:Vt.TSDT(e,t,i);break;case 8191:break;default:for(var n=!1,s=0,a=i.pat.length;s<a;s++)if(i.pat[s].pid===r){n=!0;break}if(n)Vt.PMT(e,t,i);else{for(var o,u=[],l=0,h=i.pmt.length;l<h;l++)if(i.pmt[l].pid===r){u.push(i.pmt[l]);break}0<u.length?(o=u[0].streamType,Vt.Media(e,t,o)):t.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var r=e.readUint16();i.error=r>>>15,i.payload=r>>>14&1,i.priority=r>>>13&1,i.pid=8191&r,r=e.readUint8(),i.scrambling=r>>6&3,i.adaptation=r>>4&3,i.continuity=15&r,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var r={},n=e.readUint8();e.skip(n),n=e.readUint8(),r.tabelID=n,n=e.readUint16(),r.error=n>>>7,r.zero=n>>>6&1,r.sectionLength=4095&n,r.streamID=e.readUint16(),r.current=1&e.readUint8(),r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var s=(r.sectionLength-9)/4,a=[],o=0;o<s;o++){var u=e.readUint16(),l=8191&e.readUint16();a.push({program:u,pid:l,type:0===u?"network":"mapPID"})}0<a.length&&(i.pat=i.pat.concat(a)),r.list=a,r.program=e.readUint16(),r.pid=8191&e.readUint16(),t.payload=r}},{key:"PMT",value:function(e,t,i){t.header.packet="PMT";var r=e.position;r+=e.getUint8(r);var n=(r+=1)+3+((15&e.getUint8(r+1))<<8|e.getUint8(r+2))-4;r+=12+((15&e.getUint8(r+10))<<8|e.getUint8(r+11));for(var s=[];r<n;){var a=(31&e.getUint8(r+1))<<8|e.getUint8(r+2);s.push({streamType:e.getUint8(r),pid:a}),r+=5+((15&e.getUint8(r+3))<<8|e.getUint8(r+4))}i.pmt=s,e.skip(4+n)}},{key:"Media",value:function(e,t,i){var r=t.header,n={},s=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],r=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){n=!0,s=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw s}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}(Gt[i],2),a=s[0],o=s[1];if(r.streamType=i,r.type=a,r.codec=o,3===r.adaptation&&(n.adaptationLength=e.readUint8(),0<n.adaptationLength)){var u=e.readUint8();n.discontinue=u>>>7,n.access=u>>>6&1,n.priority=u>>>5&1,n.PCR=u>>>4&1,n.OPCR=u>>>3&1,n.splicePoint=u>>>2&1,n.transportPrivate=u>>>1&1,n.adaptationField=1&u;s=e.position;if(1===n.PCR&&(n.programClockBase=e.readUint32()<<1,u=e.readUint16(),n.programClockBase|=u>>>15,n.programClockExtension=511&u),1===n.OPCR&&(n.originProgramClockBase=e.readUint32()<<1,u=e.readUint16(),n.originProgramClockBase+=u>>>15,n.originProgramClockExtension=511&u),1===n.splicePoint&&(n.spliceCountdown=e.readUint8()),1===n.transportPrivate)for(var l=e.readUint8(),h=[],c=0;c<l;c++)h.push(e.readUint8());1===n.adaptationField&&(i=e.readUint8(),a=e.readUint8(),o=e.position,r=a>>>6&1,u=a>>>5&1,1==a>>>7&&(a=e.readUint16(),n.ltwValid=a>>>15,n.ltwOffset=61439&a),1==r&&(a=e.readUint24(),n.piecewiseRate=4194303&a),1==u&&(a=e.readInt8(),n.spliceType=a>>>4,n.dtsNextAU1=a>>>1&7,n.marker1=1&a,a=e.readUint16(),n.dtsNextAU2=a>>>1,n.marker2=1&a,a=e.readUint16(),n.dtsNextAU3=a),e.skip(i-1-(e.position-o)));s=n.adaptationLength-1-(e.position-s);e.skip(s)}n.stream=new k(e.buffer.slice(e.position)),t.payload=n}},{key:"PES",value:function(e){var t={},i=e.payload.stream;if(1!==i.readUint24())t.ES={},t.ES.buffer=i;else{var r=i.readUint8();224<=r&&r<=239&&(t.type="video"),192<=r&&r<=223&&(t.type="audio");var n=i.readUint16();if(t.packetLength=n,"video"!==t.type&&"audio"!==t.type)throw new Error("format is not supported");var s=i.readUint8();if(2!=s>>>6)throw new Error("error when parse pes header");s=i.readUint8(),t.ptsDTSFlag=s>>>6,t.escrFlag=s>>>5&1,t.esRateFlag=s>>>4&1,t.dsmFlag=s>>>3&1,t.additionalFlag=s>>>2&1,t.crcFlag=s>>>1&1,t.extensionFlag=1&s,t.pesHeaderLength=i.readUint8();var a=t.pesHeaderLength,r=[];r.push(i.readUint8()),r.push(i.readUint8()),r.push(i.readUint8()),r.push(i.readUint8()),r.push(i.readUint8());var o,n=536870912*(14&r[0])+4194304*(255&r[1])+16384*(254&r[2])+128*(255&r[3])+(254&r[4])/2;if(t.purePts=n,i.dataview.position-=5,r=[],s=i.readUint8(),r.push(s>>>1&7),s=i.readUint16(),r.push(s>>>1),s=i.readUint16(),r.push(s>>>1),t.pts=r[0]<<30|r[1]<<15|r[2],a-=5,"video"===t.type&&(t.dts=t.pts),3===t.ptsDTSFlag&&(o=[],s=i.readUint8(),o.push(s>>>1&7),s=i.readUint16(),o.push(s>>>1),s=i.readUint16(),o.push(s>>>1),t.dts=o[0]<<30|o[1]<<15|o[2],a-=5),1===t.escrFlag&&(r=[],o=[],s=i.readUint8(),r.push(s>>>3&7),r.push(3&s),s=i.readUint16(),r.push(s>>>13),r.push(3&s),s=i.readUint16(),r.push(s>>>13),o.push(3&s),s=i.readUint8(),o.push(s>>>1),t.escr=300*(r[0]<<30|r[1]<<28|r[2]<<15|r[3]<<13|r[4])+(o[0]<<7|o[1]),a-=6),1===t.esRateFlag&&(s=i.readUint24(),t.esRate=s>>>1&4194303,a-=3),1===t.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===t.additionalFlag&&(s=i.readUint8(),t.additionalCopyInfo=127&s,--a),1===t.crcFlag&&(t.pesCRC=i.readUint16(),a-=2),1===t.extensionFlag)throw new Error("not support extension");0<a&&i.skip(a),t.dts>t.pts&&(t.dts=t.pts),t.ES=Vt.ES(i,t.type,e.header.streamType)}return t}},{key:"ES",value:function(e,t,i){var r={};if("video"===t)r.buffer=e;else{if("audio"!==t)throw new Error("ES "+t+" is not supported");(r=15===i||17===i?Vt.parseADTSHeader(e):r).buffer=e}return r}},{key:"parseADTSHeader",value:function(e){var t={},i=e.readUint16();if(i>>>4!=4095)throw new Error("aac ES parse Error");return t.id=0==(i>>>3&1)?"MPEG-4":"MPEG-2",t.layer=i>>>1&3,t.absent=1&i,i=e.readUint16(),t.audioObjectType=1+(i>>>14&3),t.profile=t.audioObjectType-1,t.frequencyIndex=i>>>10&15,t.frequence=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][t.frequencyIndex],t.channel=i>>>6&7,t.frameLength=(3&i)<<11|e.readUint16()>>>5,Vt.getAudioConfig(t),e.skip(1),t.buffer=e,t}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var r={};r.tableID=e.readUint8();var n=e.readUint16();r.sectionIndicator=n>>>7,r.sectionLength=4095&n,e.skip(2),n=e.readUint8(),r.version=n>>>3,r.currentNextIndicator=1&n,r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8(),this.sectionLength,r.crc32=e.readUint32(),t.payload=r}},{key:"getAudioConfig",value:function(e){var t=navigator.userAgent.toLowerCase(),i=void 0,r=void 0;e.originAudioObjectType=e.audioObjectType,r=/firefox/i.test(t)?8<=e.frequencyIndex?(e.audioObjectType=5,i=new Array(4),e.frequencyIndex-3):(e.audioObjectType=2,i=new Array(2),e.frequencyIndex):-1!==t.indexOf("android")?(e.audioObjectType=2,i=new Array(2),e.frequencyIndex):(e.audioObjectType=5,i=new Array(4),6<=e.frequencyIndex?e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,i=new Array(2)),e.frequencyIndex)),i[0]=e.audioObjectType<<3,i[0]|=(14&e.frequencyIndex)>>1,i[1]=(1&e.frequencyIndex)<<7,i[1]|=e.channel<<3,5===e.audioObjectType&&(i[1]|=(14&r)>>1,i[2]=(1&r)<<7,i[2]|=8,i[3]=0),e.audioConfig=i}}]),Vt),s=function(e,t,i){return t&&jt(e.prototype,t),i&&jt(e,i),e};function jt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Vt(e){var t=e.videoTrack,i=e.audioTrack;!function(e){if(!(e instanceof Vt))throw new TypeError("Cannot call a class as a function")}(this);e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Mt(t))&&"function"!=typeof t?e:t}(this,(Vt.__proto__||Object.getPrototypeOf(Vt)).call(this));return e.TAG="TsDemuxer",e.demuxing=!1,e.videoTrack=t,e.audioTrack=i,e.pat=[],e.pmt=[],e._hasVideoMeta=!1,e._hasAudioMeta=!1,e.gopId=0,e}var Ht=f.DEMUX_EVENTS,Xt=(s(Wt,[{key:"init",value:function(){this.on(Ht.DEMUX_START,this.demux.bind(this))}},{key:"initDemuxer",value:function(){this.demuxer.on(Nt.EVENTS.METADATA_PARSED,this.onMetaDataParsed.bind(this)),this.demuxer.on(Nt.EVENTS.VIDEO_SAMPLE_PARSED,this.onVideoSampleParsed.bind(this)),this.demuxer.on(Nt.EVENTS.AUDIO_SAMPLE_PARSED,this.onAudioSampleParsed.bind(this)),this.demuxer.on(Nt.EVENTS.SEI_PARSED,this.emit.bind(this,Ht.SEI_PARSED))}},{key:"demux",value:function(e,t){if(this._tracks){this._tracks.audioTrack||(this._tracks.audioTrack=new x),this._tracks.videoTrack||(this._tracks.videoTrack=new U),this.demuxer||(this.demuxer=new Nt(this._tracks),this.initDemuxer());try{this.demuxer.demux(e,this.inputBuffer,t)}catch(e){this.emit(Ht.DEMUX_ERROR,this.TAG,e,!1)}var i=this._tracks.videoTrack&&this._tracks.videoTrack.samples.length?1:0,t=this._tracks.audioTrack&&this._tracks.audioTrack.samples.length?1:0;this.emit(Ht.DEMUX_COMPLETE,i,t)}}},{key:"onMetaDataParsed",value:function(e,t){var i=this._tracks,r=i.videoTrack,n=i.audioTrack,s=r;switch(e){case"video":s=r;break;case"audio":s=n;break;default:s=r}s.meta=t,this.emit(Ht.METADATA_PARSED,e,t)}},{key:"onVideoSampleParsed",value:function(e){e.isKeyframe&&this.emit(Ht.ISKEYFRAME,e.pts),this._tracks.videoTrack.samples.push(e)}},{key:"onAudioSampleParsed",value:function(e){this._tracks.audioTrack.samples.push(e)}},{key:"destroy",value:function(){this.off(Ht.DEMUX_START,this.demux),this.configs={},this.demuxer&&this.demuxer.destroy()}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}]),Wt);function Yt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Wt(e){!function(e){if(!(e instanceof Wt))throw new TypeError("Cannot call a class as a function")}(this),this.configs=Object.assign({},e),this.demuxer=null}var zt=/^(?:[a-zA-Z0-9+\-.]+:)?\/\//,Kt=/^((?:[a-zA-Z0-9+\-.]+:)?\/\/[^/?#]*)?([^?#]*\/)?/,qt=(function(e,t,i){return t&&Yt(e.prototype,t),i&&Yt(e,i),e}(Qt,null,[{key:"parse",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",i={duration:0};if(e&&e.split){var r=e.split(/\r|\n/);if(!(n=(r=r.filter(function(e){return e})).shift()).match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');for(var n=r.shift(),s=!1,a=0;n;){var o=n.match(/#(.[A-Z|-]*):(.*)/),u=n.match(/#(.[A-Z|-]*)/);if(u&&o&&2<o.length)switch(o[1]){case"EXT-X-VERSION":i.version=parseInt(o[2]);break;case"EXT-X-MEDIA-SEQUENCE":i.sequence=parseInt(o[2]);break;case"EXT-X-TARGETDURATION":i.targetduration=parseFloat(o[2]);break;case"EXTINF":a=Qt.parseFrag(o,r,i,t,s,a),s=!1;break;case"EXT-X-KEY":Qt.parseDecrypt(o[2],i)}if(u&&1<u.length)switch(u[1]){case"EXT-X-DISCONTINUITY":s=!0;break;case"EXT-X-ENDLIST":i.frags[i.frags.length-1].isLast=!0,i.end=!0}n=r[a++]}return i}}},{key:"parseFrag",value:function(e,t,i,r,n,s){i.frags||(i.frags=[]);var a=new ie({start:i.duration,duration:parseInt(1e3*parseFloat(e[2]))});if(a.duration<200)return s;i.duration+=a.duration;e=t[s++];return(e.match(/#(.*):(.*)/)||e.match(/^#/))&&(e=t[s++]),a.url=function(e,t){if(!t||!e||zt.test(e))return e;t=Kt.exec(t);return t?"/"===e[0]?t[1]+e:t[1]+t[2]+e:e}(e,r),a.discontinue=n,i.frags.length?(r=i.frags[i.frags.length-1],a.id=r.id+1,a.cc=n?r.cc+1:r.cc):(a.id=i.sequence||1,a.cc=0),i.frags.push(a),s}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i,r=e.split(",");for(i in r){var n=r[i];if(n.match(/METHOD=(.*)/)&&(t.encrypt.method=n.match(/METHOD=(.*)/)[1]),n.match(/URI="(.*)"/)&&(t.encrypt.uri=n.match(/URI="(.*)"/)[1]),n.match(/IV=0x(.*)/)){var s=n.match(/IV=0x(.*)/)[1],n=Math.ceil(s.length/2);t.encrypt.ivb=new Uint8Array(n);for(var a=n-1;0<=a;a--){var o=parseInt(s.substr(2*a,2),16);t.encrypt.ivb[a]=o}t.encrypt.iv=s}}}},{key:"isHTTPS",value:function(e){return/^https:\/\//i.test(e)}}]),Qt),Zt=se(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];var s=!0,a=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(s=(u=l.next()).done);s=!0)t+=u.value.length}catch(e){a=!0,o=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw o}}var h=new e(t),c=0,d=!0,a=!1,o=void 0;try{for(var f,p=r[Symbol.iterator]();!(d=(f=p.next()).done);d=!0){var y=f.value;h.set(y,c),c+=y.length}}catch(e){a=!0,o=e}finally{try{!d&&p.return&&p.return()}finally{if(a)throw o}}return h}});function Qt(){!function(e){if(!(e instanceof Qt))throw new TypeError("Cannot call a class as a function")}(this)}ne(Zt);var Jt=ne(se(function(e){var t=Zt&&Zt.__esModule?Zt:{default:Zt};e.exports=t.default}));function $t(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ei=(function(e,t,i){return t&&$t(e.prototype,t),i&&$t(e,i),e}(ii,[{key:"write",value:function(){for(var t=this,e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];i.forEach(function(e){t.buffer=Jt(Uint8Array,t.buffer,e)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach(function(e){t+=e.toString(16).padStart(2,"0")}),parseInt(t,16)}}]),ii);function ti(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ii(e){!function(e){if(!(e instanceof ii))throw new TypeError("Cannot call a class as a function")}(this),this.buffer=e||new Uint8Array(0)}var ri=(function(e,t,i){return t&&ti(e.prototype,t),i&&ti(e,i),e}(ni,null,[{key:"size",value:function(e){return ei.writeUint32(e)}},{key:"initBox",value:function(e,t){for(var i=new ei,r=arguments.length,n=Array(2<r?r-2:0),s=2;s<r;s++)n[s-2]=arguments[s];return i.write.apply(i,[ni.size(e),ni.type(t)].concat(n)),i.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return ni.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return ni.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(e){var t=e.type,i=e.meta,r=8,n=ni.mvhd(i.duration,i.timescale),e=void 0,e="video"===t?ni.videoTrak(i):ni.audioTrak(i),i=ni.mvex(i.duration,i.timescale||1e3,i.id);return[n,e,i].forEach(function(e){r+=e.byteLength}),ni.initBox(r,"moov",n,e,i)}},{key:"mvhd",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1e3,e=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,e>>>24&255,e>>>16&255,e>>>8&255,255&e,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return ni.initBox(8+e.length,"mvhd",new Uint8Array(e))}},{key:"videoTrak",value:function(e){var t=8,i=ni.tkhd({id:1,duration:e.duration,timescale:e.timescale||1e3,width:e.presentWidth,height:e.presentHeight,type:"video"}),e=ni.mdia({type:"video",timescale:e.timescale||1e3,duration:e.duration,avcc:e.avcc,parRatio:e.parRatio,width:e.presentWidth,height:e.presentHeight,streamType:e.streamType});return[i,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"trak",i,e)}},{key:"audioTrak",value:function(e){var t=8,i=ni.tkhd({id:2,duration:e.duration,timescale:e.timescale||1e3,width:0,height:0,type:"audio"}),e=ni.mdia({type:"audio",timescale:e.timescale||1e3,duration:e.duration,channelCount:e.channelCount,samplerate:e.sampleRate,config:e.config});return[i,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"trak",i,e)}},{key:"tkhd",value:function(e){var t=e.id,i=e.duration,r=e.width,e=e.height,e=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>>8&255,255&r,0,0,e>>>8&255,255&e,0,0]);return ni.initBox(8+e.byteLength,"tkhd",e)}},{key:"edts",value:function(e){var t=new ei,i=e.duration,e=e.mediaTime;return t.write(ni.size(36),ni.type("edts")),t.write(ni.size(28),ni.type("elst")),t.write(new Uint8Array([0,0,0,1,i>>24&255,i>>16&255,i>>8&255,255&i,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,1])),t.buffer}},{key:"mdia",value:function(e){var t=8,i=ni.mdhd(e.timescale,e.duration),r=ni.hdlr(e.type),e=ni.minf(e);return[i,r,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"mdia",i,r,e)}},{key:"mdhd",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments[1],t=new Uint8Array([0,0,0,0,0,0,0,0,e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,85,196,0,0]);return ni.initBox(12+t.byteLength,"mdhd",ni.extension(0,0),t)}},{key:"hdlr",value:function(e){var t=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===e&&(t.splice.apply(t,[8,4].concat([115,111,117,110])),t.splice.apply(t,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),ni.initBox(8+t.length,"hdlr",new Uint8Array(t))}},{key:"minf",value:function(e){var t=8,i="video"===e.type?ni.vmhd():ni.smhd(),r=ni.dinf(),e=ni.stbl(e);return[i,r,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"minf",i,r,e)}},{key:"vmhd",value:function(){return ni.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return ni.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var e=new ei;return e.write(ni.size(36),ni.type("dinf"),ni.size(28),ni.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),e.buffer}},{key:"stbl",value:function(e){var t=8,i=ni.stsd(e),r=ni.stts(),n=ni.stsc(),s=ni.stsz(),e=ni.stco();return[i,r,n,s,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"stbl",i,r,n,s,e)}},{key:"stsd",value:function(e){var t="audio"===e.type?ni.mp4a(e):36===e.streamType?ni.hvc1(e):ni.avc1(e);return ni.initBox(16+t.byteLength,"stsd",ni.extension(0,0),new Uint8Array([0,0,0,1]),t)}},{key:"mp4a",value:function(e){var t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,e.samplerate>>8&255,255&e.samplerate,0,0]),e=ni.esds(e.config);return ni.initBox(8+t.byteLength+e.byteLength,"mp4a",t,e)}},{key:"esds",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],t=e.length,i=new ei,e=new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e).concat([6,1,2]));return i.write(ni.size(8+e.byteLength),ni.type("esds"),e),i.buffer}},{key:"avc1",value:function(e){var t=new ei,i=e.width,r=e.height,n=e.parRatio.width,s=e.parRatio.height,e=e.avcc,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>8&255,255&i,r>>8&255,255&r,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),r=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),s=new Uint8Array([n>>24,n>>16&255,n>>8&255,255&n,s>>24,s>>16&255,s>>8&255,255&s]);return t.write(ni.size(40+i.byteLength+e.byteLength+r.byteLength),ni.type("avc1"),i,ni.size(8+e.byteLength),ni.type("avcC"),e,ni.size(20),ni.type("btrt"),r,ni.size(16),ni.type("pasp"),s),t.buffer}},{key:"hvc1",value:function(e){var t=new ei,e=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e.width>>8&255,255&e.width,e.height>>8&255,255&e.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,122,104,118,99,67,1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64]);return t.write(ni.size(8+e.byteLength+10),ni.type("hvc1"),e,ni.size(10),ni.type("fiel"),new Uint8Array([1,0])),t.buffer}},{key:"stts",value:function(){var e=new Uint8Array([0,0,0,0,0,0,0,0]);return ni.initBox(16,"stts",e)}},{key:"stsc",value:function(){var e=new Uint8Array([0,0,0,0,0,0,0,0]);return ni.initBox(16,"stsc",e)}},{key:"stco",value:function(){var e=new Uint8Array([0,0,0,0,0,0,0,0]);return ni.initBox(16,"stco",e)}},{key:"stsz",value:function(){var e=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return ni.initBox(20,"stsz",e)}},{key:"mvex",value:function(e){var t=arguments[2],i=new ei,e=ei.writeUint32(e);return i.write(ni.size(56),ni.type("mvex"),ni.size(16),ni.type("mehd"),ni.extension(0,0),e,ni.trex(t)),i.buffer}},{key:"trex",value:function(e){e=new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return ni.initBox(8+e.byteLength,"trex",e)}},{key:"moof",value:function(e){var t=8,i=ni.mfhd(),e=ni.traf(e);return[i,e].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"moof",i,e)}},{key:"mfhd",value:function(){var e=ei.writeUint32(ni.sequence);return ni.sequence+=1,ni.initBox(16,"mfhd",ni.extension(0,0),e)}},{key:"traf",value:function(e){var t=8,i=ni.tfhd(e.id),r=ni.tfdt(e.time),n=ni.sdtp(e),e=ni.trun(e,n.byteLength);return[i,r,e,n].forEach(function(e){t+=e.byteLength}),ni.initBox(t,"traf",i,r,e,n)}},{key:"tfhd",value:function(e){e=ei.writeUint32(e);return ni.initBox(16,"tfhd",ni.extension(0,0),e)}},{key:"tfdt",value:function(e){return ni.initBox(16,"tfdt",ni.extension(0,0),ei.writeUint32(e))}},{key:"trun",value:function(e,t){var i=new ei,r=ei.writeUint32(e.samples.length),t=ei.writeUint32(92+16*e.samples.length+t);return i.write(ni.size(20+16*e.samples.length),ni.type("trun"),new Uint8Array([0,0,15,1]),r,t),e.samples.forEach(function(e){var t=e.flags;i.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),i.buffer}},{key:"sdtp",value:function(e){var t=new ei;return t.write(ni.size(12+e.samples.length),ni.type("sdtp"),ni.extension(0,0)),e.samples.forEach(function(e){e=e.flags,e=e.isLeading<<6|e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy;t.write(new Uint8Array([e]))}),t.buffer}},{key:"mdat",value:function(e){var t=new ei,i=8;e.samples.forEach(function(e){i+=e.size}),t.write(ni.size(i),ni.type("mdat"));var r=new Uint8Array(i),n=0;return r.set(t.buffer,n),n+=8,e.samples.forEach(function(e){e.buffer.forEach(function(e){r.set(e,n),n+=e.byteLength})}),r}}]),ni);function ni(){!function(e){if(!(e instanceof ni))throw new TypeError("Cannot call a class as a function")}(this)}ri.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},ri.sequence=1;var si="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t,i){return t&&ai(e.prototype,t),i&&ai(e,i),e};function ai(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var oi=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":si(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(li,n),s(li,[{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1,this.mp4Durations={keys:[]},this.removeAllListeners()}},{key:"remux",value:function(e,t){this._isDtsBaseInited||this.calcDtsBase(e,t),this.remuxVideo(t),this.remuxAudio(e),Be.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){Be.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited&&(this._isDtsBaseInited=!1),this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"remuxInitSegment",value:function(e,t){Be.log(this.TAG,"remuxInitSegment: type=",e);var i=new ei,r=36===t.streamType?ri.ftypHEVC():ri.ftyp(),t=ri.moov({type:e,meta:t});return i.write(r,t),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i=t.samples[0],r=void 0;return i.options&&i.options.start&&(r=i.options.start),this._videoDtsBase=i.dts-(r||this._dtsBase),void(this._isDtsBaseInited=!0)}var n,s,a;(e&&e.samples.length||t&&t.samples.length)&&(r=i=n=null,e&&e.samples&&e.samples.length&&(n=(s=e.samples[0]).dts,s.options&&s.options.start&&(r=s.options.start)),t&&t.samples&&t.samples.length&&(i=(s=t.samples[0]).dts,s.options&&s.options.start&&(r=s.options.start)),a=n-i,n&&a<0&&null!==r&&t.samples.forEach(function(e){e.dts-=a,e.pts&&(e.pts-=a)}),this._videoDtsBase=(i||n)-(r||this._dtsBase),this._audioDtsBase=(n||i)-(r||this._dtsBase),this._dtsBase=Math.min(i,n),this._isDtsBaseInited=!0,Be.log(this.TAG,"calcDtsBase"),Be.log(this.TAG,"video first dts: "+i+" , start:"+r+" , _videoDtsBase:"+this._videoDtsBase+" , _dtsBase:"+this._dtsBase),Be.log(this.TAG,"audio first dts: "+n+" , start:"+r+" , _audioDtsBase:"+this._audioDtsBase+", _dtsBase:"+this._dtsBase))}},{key:"remuxVideo",value:function(e){var t=this,i=e||{};if(e&&e.samples&&e.samples.length){var r=i.samples;if(i.meta){for(var n,s=-1,a=null,o=[],u={samples:[]},l=1e4;r.length&&0<l--;){var h=r.shift(),c=h.isKeyframe,d=h.options;if(!this.isFirstVideo&&d&&d.meta){a=this.remuxInitSegment("video",d.meta),d.meta=null,r.unshift(h),d.isContinue||(this._videoDtsBase=0);break}var f=Math.max(0,h.dts-this.videoDtsBase);-1===s&&(s=f);var p=void 0,y=void 0;void 0!==h.pts&&(p=(y=h.pts-this._dtsBase)-f),void 0!==h.cts&&(y=h.cts+f,p=h.cts);var _={buffer:[],size:0},d=0,d=h.duration||(1<=r.length?r[0].dts-this.videoDtsBase-f:1<=o.length?o[o.length-1].duration:this._videoMeta.refSampleDuration);this.videoAllDuration+=d,Be.long&&Be.log(this.TAG,"video dts "+f,"pts "+y,"cts: "+p,c,"originDts "+h.originDts,"duration "+d),0<=d&&(u.samples.push(_),_.buffer.push(h.data),_.size+=h.data.byteLength,o.push({dts:f,cts:p,pts:y,data:h.data,size:h.data.byteLength,isKeyframe:c,duration:d,flags:{isLeading:0,dependsOn:c?2:1,isDependedOn:c?1:0,hasRedundancy:0,isNonSync:c?0:1},originDts:f,type:"video"}),this.mp4Durations[y]=d,this.mp4Durations.keys.push(y)),c&&this.emit(li.EVENTS.RANDOM_ACCESS_POINT,y)}1e4<this.mp4Durations.keys.length&&(n=this.mp4Durations,this.mp4Durations={},this.mp4Durations.keys=n.keys.slice(-100),this.mp4Durations.keys.forEach(function(e){t.mp4Durations[e]=n[e]})),o.length&&Be.log(this.TAG,"remux to mp4 video:",[s/1e3,o[o.length-1].dts/1e3]);var v,m=new ei;if(o.length&&i.meta&&(v=ri.moof({id:i.meta.id,time:s,samples:o}),e=ri.mdat(u),m.write(v,e),this.segmentRemuxed("video",m,o[o.length-1].pts-o[0].pts)),a&&(this.segmentRemuxed("video",a),r.length))return i.samples=r,this.remuxVideo(i);this.isFirstVideo=!1,this.emit(li.EVENTS.TRACK_REMUXED,"video",m),i.samples=[],i.length=0}}}},{key:"remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],n=null,s={samples:[]};if(t&&t.length){for(var a=1e4,o=!1;t.length&&0<a--;){var u=t.shift(),l=u.data,h=u.options;if(!this.isFirstAudio&&h&&h.meta){n=this.remuxInitSegment("audio",h.meta),h.meta=null,t.unshift(u),h.isContinue||(this._audioDtsBase=0);break}var c=Math.max(0,u.dts-this.audioDtsBase),d=u.originDts;o||(i=c,o=!0);h=0,h=u.duration||this._audioMeta.refSampleDurationFixed||(1<=t.length?t[0].dts-this.audioDtsBase-c:1<=r.length?r[r.length-1].duration:this._audioMeta.refSampleDuration);this.audioAllDuration+=h;u={dts:c,pts:c,cts:0,size:l.byteLength,duration:u.duration||h,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:d,type:"audio"},d={buffer:[],size:0};0<=h&&(d.buffer.push(l),d.size+=l.byteLength,s.samples.push(d),r.push(u))}var f,p,y=new ei;if(r.length&&e.meta&&(Be.log(this.TAG,"remux to mp4 audio:",[i/1e3,r[r.length-1].dts/1e3]),f=ri.moof({id:e.meta.id,time:i,samples:r}),p=ri.mdat(s),y.write(f,p),this.segmentRemuxed("audio",y,r[r.length-1].dts-r[0].dts)),n&&(this.segmentRemuxed("audio",n),t.length))return e.samples=t,this.remuxAudio(e);this.isFirstAudio=!1,this.emit(li.EVENTS.TRACK_REMUXED,"audio",y),e.samples=[],e.length=0}}},{key:"segmentRemuxed",value:function(e,t,i){this.emit(li.EVENTS.MEDIA_SEGMENT,e,t,i)}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase},set:function(e){this._videoDtsBase=e}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],[{key:"EVENTS",get:function(){return{MEDIA_SEGMENT:"MEDIA_SEGMENT",INIT_SEGMENT:"INIT_SEGMENT",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",TRACK_REMUXED:"TRACK_REMUXED"}}}]),li),s=function(e,t,i){return t&&ui(e.prototype,t),i&&ui(e,i),e};function ui(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function li(e){var t=e.videoMeta,i=e.audioMeta,r=e.curTime;!function(e){if(!(e instanceof li))throw new TypeError("Cannot call a class as a function")}(this);e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":si(t))&&"function"!=typeof t?e:t}(this,(li.__proto__||Object.getPrototypeOf(li)).call(this));return e.TAG="Fmp4Remuxer",e._dtsBase=1e3*r,e._videoMeta=t,e._audioMeta=i,e._audioDtsBase=null,e._videoDtsBase=null,e._isDtsBaseInited=!1,e.isFirstVideo=!0,e.isFirstAudio=!0,e.videoAllDuration=0,e.audioAllDuration=0,e.audioRemuxed=0,e.videoRemuxed=0,e.mp4Durations={keys:[]},e}function hi(e,t,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);return void 0!==r?"value"in r?r.value:void 0!==(r=r.get)?r.call(i):void 0:null===(e=Object.getPrototypeOf(e))?void 0:hi(e,t,i)}var ci=f.REMUX_EVENTS,di=f.PLAYER_EVENTS,fi=(s(vi,[{key:"init",value:function(){this.on(ci.REMUX_MEDIA,this.remux.bind(this)),this.on(ci.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(ci.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(ci.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(di.SEEK,this.seek.bind(this))}},{key:"initRemuxer",value:function(){this.remuxer=new oi({audioMeta:null,videoMeta:null,curTime:this._curTime}),this.remuxer.on(oi.EVENTS.MEDIA_SEGMENT,this.writeToSource.bind(this)),this.remuxer.on(oi.EVENTS.TRACK_REMUXED,this.onTrackRemuxed.bind(this))}},{key:"remux",value:function(){this.remuxer._videoMeta||(this.remuxer._videoMeta=this.videoMeta,this.remuxer._audioMeta=this.audioMeta);var e=this._context.getInstance("TRACKS"),t=e.audioTrack,e=e.videoTrack;return this.remuxer.remux(t,e)}},{key:"resetDtsBase",value:function(){this.remuxer&&this.remuxer.resetDtsBase()}},{key:"seek",value:function(e){this.remuxer&&this.remuxer.seek(e)}},{key:"onMetaDataReady",value:function(e){this.remuxer||this.initRemuxer();var t=void 0,t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack,i=this._context.getInstance("PRE_SOURCE_BUFFER"),r=i.getSource(e);(r=r||i.createSource(e)).mimetype=t.meta.codec,r.init=this.remuxer.remuxInitSegment(e,t.meta),this.emit(ci.INIT_SEGMENT,e)}},{key:"onTrackRemuxed",value:function(e){this.emit(ci.MEDIA_SEGMENT,e)}},{key:"writeToSource",value:function(e,t,i){var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);(n=n||r.createSource(e)).data.push(t),i&&(n.bufferDuration=i+(n.bufferDuration||0))}},{key:"destroy",value:function(){this.remuxer&&this.remuxer.destroy(),this.remuxer=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}}]),vi),pi={Mse:be,Tracks:L,RemuxedBufferManager:E,XgBuffer:I,FetchLoader:xe,Compatibility:Ut,Mp4Remuxer:fi,Crypto:ve,M3U8Parser:qt,TsDemuxer:Xt,Playlist:y},yi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t,i){return t&&_i(e.prototype,t),i&&_i(e,i),e};function _i(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function vi(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")})(this,vi),this.TAG="Mp4Remuxer",this._curTime=e,this.remuxer||this.initRemuxer()}var mi=f.HlsAllowedEvents,gi=f.REMUX_EVENTS,Ei=i.util,bi=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":yi(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(Ti,i),s(Ti,[{key:"_initEvents",value:function(){var i=this;this.__core__.once(gi.INIT_SEGMENT,function(){var e,t=i._context.getInstance("MSE");i.started||(e=Ei.createDom("xg-live","正在直播",{},"xgplayer-live"),Ei.addClass(i.root,"xgplayer-is-live"),i.controls.appendChild(e)),i.started=!0,hi(Ti.prototype.__proto__||Object.getPrototypeOf(Ti.prototype),"start",i).call(i,t.url)})}},{key:"start",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.config.url;e&&!this.started&&(this._context||(this._context=new fe(this,this.hlsOps,mi)),this.hlsOps||(this.hlsOps={},this.hlsOps=Object.assign(this.hlsOps,pi),Ei.deepCopy(this.hlsOps,this.config),this._played=!1),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",Ye)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.url=e,this.__core__.load(e),this._initEvents(),this.started=!0)}},{key:"play",value:function(){var e=this;if(this._played)return this.src=this.config.url,void this.once("canplay",function(){e.video.play()});this._played=!0,hi(Ti.prototype.__proto__||Object.getPrototypeOf(Ti.prototype),"play",this).call(this)}},{key:"destroy",value:function(){var t=this;this._context&&this._context.destroy();var e=new Promise(function(e){t.__core__&&t.__core__.mse?t.__core__.mse.destroy().then(function(){setTimeout(function(){e()},50)}):setTimeout(function(){e()},50)});return hi(Ti.prototype.__proto__||Object.getPrototypeOf(Ti.prototype),"destroy",this).call(this),e}},{key:"src",set:function(e){var t=this;this.onWaiting=this.onWaiting.bind(this),this.__core__.mse.destroy().then(function(){t._context.destroy(),t._context=null,t.started=!1,t.video.currentTime=0,t.start(e)})}}],[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(e,t){return i.install(e,t)}}]),Ti);function Ti(e){!function(e){if(!(e instanceof Ti))throw new TypeError("Cannot call a class as a function")}(this);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":yi(t))&&"function"!=typeof t?e:t}(this,(Ti.__proto__||Object.getPrototypeOf(Ti)).call(this,e));return t.hlsOps={},t.hlsOps=Object.assign(t.hlsOps,pi),Ei.deepCopy(t.hlsOps,e),t._played=!1,t}bi.install=i.install.bind(i);s=function(e,t,i){return t&&ki(e.prototype,t),i&&ki(e,i),e};function ki(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Si(e,t,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);return void 0!==r?"value"in r?r.value:void 0!==(r=r.get)?r.call(i):void 0:null===(e=Object.getPrototypeOf(e))?void 0:Si(e,t,i)}var Ai=u,Di=r,Ri=f.LOADER_EVENTS,wi=f.DEMUX_EVENTS,Oi=f.HLS_EVENTS,Li=f.CRYTO_EVENTS,xi=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,Ui=(s(Pi,[{key:"init",value:function(){var e=this._player.hlsOps,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.FetchLoader,e=e.TsDemuxer;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._context.registry("TRACKS",i),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0}),this._m3u8loader=this._context.registry("M3U8_LOADER",n)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",n)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",e)({inputbuffer:"TS_BUFFER"}),this.initEvents()}},{key:"initEvents",value:function(){this.on(Ri.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(wi.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(wi.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(wi.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(Ri.LOADER_ERROR,this._onLoadError.bind(this)),this.on(wi.DEMUX_ERROR,this._onDemuxError.bind(this))}},{key:"_onError",value:function(e,t,i,r){r={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",r)}},{key:"_onDemuxComplete",value:function(){var s,e,a=this;this._player.video&&(e=this._context.getInstance("TRACKS"),s=e.videoTrack,e=e.audioTrack,s.samples.forEach(function(e){var t,i,r,n;e.analyzed||(e.analyzed=!0,i=new k(e.data.buffer),t=void 0,i=(t=a._isHEVC(s.meta)?Ai.getHvccNals(i):Di.getNalunits(i)).reduce(function(e,t){return e+4+t.body.byteLength},0),r=new Uint8Array(i),n=0,t.forEach(function(e){r.set([0,0,0,1],n),n+=4,r.set(new Uint8Array(e.body),n),n+=e.body.byteLength}),e.data=r)}),this._player.video.onDemuxComplete(s,e))}},{key:"_onMetadataParsed",value:function(e){var t;"audio"===e?(t=this._context.getInstance("TRACKS").audioTrack)&&t.meta&&this._setMetaToAudio(t.meta):(t=this._context.getInstance("TRACKS").videoTrack)&&t.meta&&this._setMetaToVideo(t.meta)}},{key:"_setMetaToAudio",value:function(e){this._player.video&&this._player.video.setAudioMeta(e)}},{key:"_setMetaToVideo",value:function(e){this._player.video&&this._player.video.setVideoMeta(e)}},{key:"_onLoadError",value:function(e,t){!this._tsloader.loading&&!this._m3u8loader.loading&&1<this.retrytimes?(this.retrytimes--,this._onError(Ri.LOADER_ERROR,e,t,!1)):this.retrytimes<=1&&(this._onError(Ri.LOADER_ERROR,e,t,!0),this.emit(Oi.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}},{key:"_onDemuxError",value:function(e,t,i){this._onError(Ri.LOADER_ERROR,e,t,i=void 0===i?!0:i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){if("M3U8_BUFFER"===e.TAG){var t,i=void 0;try{this.m3u8Text=e.shift();var r=xi.exec(this.m3u8Text);r&&r[2]?this.load(r[2]):i=this._player.hlsOps.M3U8Parser.parse(this.m3u8Text,this.url)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(i){try{this._playlist.pushM3U8(i,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key?(r=(t=this._player.hlsOps).XgBuffer,t=t.FetchLoader,this._context.registry("DECRYPT_BUFFER",r)(),this._context.registry("KEY_BUFFER",r)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",t)({buffer:"KEY_BUFFER",readtype:3}),this.emitTo("KEY_LOADER",Ri.LADER_START,this._playlist.encrypt.uri)):this._m3u8Loaded(i)}else 0<this.retrytimes?(this.retrytimes--,this._preload()):(this.emit(Oi.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}else"TS_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emit(wi.DEMUX_START)):"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",Li.START_DECRYPT)):"KEY_BUFFER"===e.TAG&&(i=this._player.hlsOps.Crypto,this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",i)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(Li.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_onDcripted",value:function(){this.emit(wi.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.preloadTime||(this.preloadTime=this._playlist.targetduration||5),0<this._playlist.fragLength&&this._playlist.sequence<e.sequence?this.retrytimes=this.configs.retrytimes||3:0<this.retrytimes?(this.retrytimes--,this._preload()):(this.emit(Oi.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}},{key:"_checkStatus",value:function(){var e;this.retrytimes<1&&(new Date).getTime()-this._lastCheck<1e4||(this._lastCheck=(new Date).getTime(),this.container.buffered.length<1?this._preload():(e=this.container.currentTime,this.container.readyState<=2&&this._preload(),e>this.container.buffered.end(this.container.buffered.length-1)-this.preloadTime&&this._preload()))}},{key:"_preload",value:function(){var e,t,i;this._tsloader.loading||this._m3u8loader.loading||(!(e=this._playlist.getTs())||e.downloaded||e.downloading?(t=this.preloadTime||0,i=(new Date).getTime(),(!e||e.downloaded)&&(i-this._m3u8lasttime)/1e3>t&&(this._m3u8lasttime=i,this.emitTo("M3U8_LOADER",Ri.LADER_START,this.url))):(this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",Ri.LADER_START,e.url)))}},{key:"_isHEVC",value:function(e){return e&&"hev1.1.6.L93.B0"===e.codec}},{key:"load",value:function(e){this.url=e,this._preload()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(Ri.LOADER_COMPLETE,this._onLoadComplete),this.off(wi.METADATA_PARSED,this._onMetadataParsed),this.off(wi.DEMUX_COMPLETE,this._onDemuxComplete),this.m3u8Text=null}}]),Pi),Mi={Tracks:L,XgBuffer:I,FetchLoader:xe,Crypto:ve,M3U8Parser:qt,TsDemuxer:Xt,Playlist:y},Ci="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t,i){return t&&Bi(e.prototype,t),i&&Bi(e,i),e};function Bi(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Pi(e){!function(e){if(!(e instanceof Pi))throw new TypeError("Cannot call a class as a function")}(this),this.configs=Object.assign({},e),this.url="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.preloadTime=this.configs.preloadTime,this.container=this.configs.container,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),50),this._lastCheck=0,this.m3u8Text=null}var Ii=f.HlsAllowedEvents,Fi=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Ci(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(Gi,i),s(Gi,null,[{key:"isSupported",value:function(){var e="WebAssembly"in window,t=!1;return"customElements"in window&&window.customElements.define&&(t=window.customElements.get("live-video")),e&&t}}]),s(Gi,[{key:"initPlayer",value:function(){this.video.width=Number.parseInt(this.hlsOps.width||600),this.video.height=Number.parseInt(this.hlsOps.height||337.5),this.video.style.outline="none",this.playerInited=!0}},{key:"_initEvents",value:function(){var e=this;this.once("canplay",function(){e.video.play()})}},{key:"start",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.hlsOps.url;e&&!this.started&&(this.playerInited||this.initPlayer(),this._context||(this._context=new fe(Ii)),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",Ui)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.url=e,this.__core__.load(e),Si(Gi.prototype.__proto__||Object.getPrototypeOf(Gi.prototype),"start",this).call(this,e),this._initEvents(),this.started=!0,this.addLiveFlag())}},{key:"play",value:function(){this.started&&(this._context.destroy(),this._context=new fe(Ii),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",Ui)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this._initEvents(),this.__core__.load(this.url)),Si(Gi.prototype.__proto__||Object.getPrototypeOf(Gi.prototype),"play",this).call(this)}},{key:"addLiveFlag",value:function(){var e;i.util.addClass(this.root,"xgplayer-is-live"),i.util.findDom(this.root,"xg-live")||(e=i.util.createDom("xg-live","正在直播",{},"xgplayer-live"),this.controls.appendChild(e))}},{key:"destroy",value:function(){var r=this,n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return new Promise(function(e){Si(Gi.prototype.__proto__||Object.getPrototypeOf(Gi.prototype),"destroy",r).call(r);var t=r.video,i=r.root;Si(Gi.prototype.__proto__||Object.getPrototypeOf(Gi.prototype),"destroy",r).call(r,n),t&&t.remove?t.remove():i&&i.removeChild(t),t&&t.destroy(),setTimeout(function(){e()},50)})}},{key:"src",set:function(e){this.onWaiting=this.onWaiting.bind(this),this._context.destroy(),this._context=null,this.started=!1,this.video.currentTime=0,this.start(e)}}],[{key:"install",value:function(e,t){return i.install(e,t)}}]),Gi);function Gi(e){!function(e){if(!(e instanceof Gi))throw new TypeError("Cannot call a class as a function")}(this),e.mediaType||(e.mediaType="live-video",e.videoConfig?e.videoConfig.preloadtime=e.preloadTime||5:e.videoConfig={preloadtime:e.preloadTime||5});var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Ci(t))&&"function"!=typeof t?e:t}(this,(Gi.__proto__||Object.getPrototypeOf(Gi)).call(this,e));return t.hlsOps={},t.util=i.util,t.hlsOps=Object.assign(t.hlsOps,Mi),t.util.deepCopy(t.hlsOps,e),t.playerInited||t.initPlayer(),t}function Ni(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Fi.install=i.install.bind(i);var ji=(function(e,t,i){return t&&Ni(e.prototype,t),i&&Ni(e,i),e}(Vi,null,[{key:"install",value:function(e,t){return i.install(e,t)}}]),Vi);function Vi(e){return function(e){if(!(e instanceof Vi))throw new TypeError("Cannot call a class as a function")}(this),new(Fi.isSupported()&&e.useWASM?Fi:bi.isSupported()?bi:i)(e)}ji.EVENTS=f;s=function(e,t,i){return t&&Hi(e.prototype,t),i&&Hi(e,i),e};function Hi(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Xi(e,t,i,r){var n=Object.getOwnPropertyDescriptor(e,t);return void 0===n?null!==(e=Object.getPrototypeOf(e))&&Xi(e,t,i,r):"value"in n&&n.writable?n.value=i:void 0!==(n=n.set)&&n.call(r,i),i}function Yi(e,t,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);return void 0!==r?"value"in r?r.value:void 0!==(r=r.get)?r.call(i):void 0:null===(e=Object.getPrototypeOf(e))?void 0:Yi(e,t,i)}var Wi=f.LOADER_EVENTS,zi=f.REMUX_EVENTS,Ki=f.DEMUX_EVENTS,qi=f.CRYTO_EVENTS,Zi=f.MSE_EVENTS,Qi=(s(er,[{key:"init",value:function(){this._context.registry("M3U8_BUFFER",I),this._tsBuffer=this._context.registry("TS_BUFFER",I)(),this._tracks=this._context.registry("TRACKS",L)(),this._playlist=this._context.registry("PLAYLIST",y)({autoclear:!1}),this._presource=this._context.registry("PRE_SOURCE_BUFFER",E)(),this._compat=this._context.registry("COMPATIBILITY",Ut)(),this._context.registry("M3U8_LOADER",xe)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",xe)({buffer:"TS_BUFFER",readtype:3}),this._demuxer=this._context.registry("TS_DEMUXER",Xt)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",fi)(this._player.currentTime),this.mse||(this.mse=new be({container:this.container,preloadTime:this.preloadTime},this._context),this.mse.init()),this.initEvents()}},{key:"initEvents",value:function(){this._onLoaderCompete=this._onLoaderCompete.bind(this),this._onLoadError=this._onLoadError.bind(this),this._onInitSegment=this._onInitSegment.bind(this),this._handleSEIParsed=this._handleSEIParsed.bind(this),this._onMediaSegment=this._onMediaSegment.bind(this),this._onMetadataParsed=this._onMetadataParsed.bind(this),this._onDemuxComplete=this._onDemuxComplete.bind(this),this._onDemuxError=this._onDemuxError.bind(this),this._onRemuxError=this._onRemuxError.bind(this),this._handleMseError=this._handleMseError.bind(this),this._onUpdateEnd=this._onUpdateEnd.bind(this),this._onTimeUpdate=this._onTimeUpdate.bind(this),this._onWaiting=this._onWaiting.bind(this),this.on(Wi.LOADER_COMPLETE,this._onLoaderCompete),this.on(Wi.LOADER_ERROR,this._onLoadError),this.on(zi.INIT_SEGMENT,this._onInitSegment),this.on(Ki.SEI_PARSED,this._handleSEIParsed),this.on(zi.MEDIA_SEGMENT,this._onMediaSegment),this.on(Ki.METADATA_PARSED,this._onMetadataParsed),this.on(Ki.DEMUX_COMPLETE,this._onDemuxComplete),this.on(Ki.DEMUX_ERROR,this._onDemuxError),this.on(zi.REMUX_ERROR,this._onRemuxError),this.on(Zi.MSE_ERROR,this._handleMseError),this.on(Zi.SOURCE_UPDATE_END,this._onUpdateEnd),this.on("TIME_UPDATE",this._onTimeUpdate),this.on(Zi.SOURCE_UPDATE_END,this._onTimeUpdate),this.on("WAITING",this._onWaiting)}},{key:"_onError",value:function(e,t,i,r){r={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:r};this._player&&this._player.emit("HLS_ERROR",r)}},{key:"_onLoadError",value:function(e,t){this._player.emit("error",{errorType:"network",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Wi.LOADER_ERROR,e,t,!0)}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Wi.LOADER_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(zi.REMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{errorType:"format",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Zi.MSE_ERROR,e,t,i)}},{key:"_onWaiting",value:function(e){var t=!0;Be.log(this.TAG,"waiting.......",this._player.video.currentTime),this._seekToBufferStart();var i=Object.keys(this._playlist.list),r=i.length;if(r){for(var n,s=0;s<r;s++)1e3*this.container.currentTime<parseInt(i[s])&&(t=!1);t&&((n=this._playlist.getTs(1e3*this.container.currentTime))&&!n.downloaded||(this._player.emit("ended"),this.mse.endOfStream()))}}},{key:"_seekToBufferStart",value:function(){var e=this._player.video,t=e.buffered,i=[0,0],r=e.currentTime;if(t)for(var n=0,s=t.length;n<s;n++)if(i[0]=t.start(n),i[1]=t.end(n),i[0]<=r&&r<=i[1])return;var a=i[0];0===r&&r<a&&Math.abs(r-a)<5&&(e.currentTime=a)}},{key:"_checkEnd",value:function(){var e=this._player.video,t=e.buffered,i=t.length;i&&(i=t.end(i-1),Math.abs(i-e.duration)<1&&this.mse.endOfStream())}},{key:"_onUpdateEnd",value:function(){this._checkEnd(),this._seekToBufferStart(),this._preload(this._player.currentTime)}},{key:"_onTimeUpdate",value:function(){this._seekToBufferStart(),this._preload(this._player.currentTime)}},{key:"_onDemuxComplete",value:function(){this.emit(zi.REMUX_MEDIA,"ts")}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onMetadataParsed",value:function(e){try{var t=this._tracks[e+"Track"].meta;Be.warn(this.TAG,"meta detect or changed , ",e,Object.assign({},t))}catch(e){}t=parseInt(this._playlist.duration);"video"===e?(this._context.mediaInfo.hasVideo=!0,this._tracks.videoTrack.meta.duration=t):"audio"===e&&(this._context.mediaInfo.hasAudio=!0,this._tracks.audioTrack.meta.duration=t),this.emit(zi.REMUX_METADATA,e)}},{key:"_onMediaSegment",value:function(){Object.keys(this.mse.sourceBuffers).length<1&&this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_onInitSegment",value:function(){this.mse.addSourceBuffers()}},{key:"_onLoaderCompete",value:function(e){if("M3U8_BUFFER"===e.TAG){this.m3u8Text=e.shift();try{var t=qt.parse(this.m3u8Text,this.url);this._playlist.pushM3U8(t)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!0)}this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key?(this._context.registry("DECRYPT_BUFFER",I)(),this._context.registry("KEY_BUFFER",I)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",xe)({buffer:"KEY_BUFFER",readtype:3}),this.emitTo("KEY_LOADER",Wi.LADER_START,this._playlist.encrypt.uri)):(this.preloadTime||(this._playlist.targetduration?(this.preloadTime=this._playlist.targetduration,this.mse.preloadTime=this._playlist.targetduration):(this.preloadTime=5,this.mse.preloadTime=5)),(i=this._playlist.getTs(1e3*(this._player.currentTime+.5)))?(this._logDownSegment(i),this._playlist.downloading(i.url,!0),this.emitTo("TS_LOADER",Wi.LADER_START,i.url)):0<this.retrytimes&&(this.retrytimes--,this.emitTo("M3U8_LOADER",Wi.LADER_START,this.url)))}else{var i;"TS_BUFFER"===e.TAG?(this._playlist.downloaded(this._tsloader.url,!0),this._demuxer.demux(Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url]),!0),this._preload(this.mse.container.currentTime)):"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",qi.START_DECRYPT,Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url]))):"KEY_BUFFER"===e.TAG&&(this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",ve)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(qi.DECRYPTED,this._onDcripted.bind(this)),(i=this._playlist.getTs())?(this._playlist.downloading(i.url,!0),this.emitTo("TS_LOADER",Wi.LADER_START,i.url)):0<this.retrytimes&&(this.retrytimes--,this.emitTo("M3U8_LOADER",Wi.LADER_START,this.url)))}}},{key:"_onDcripted",value:function(){this.emit(Ki.DEMUX_START)}},{key:"seek",value:function(e){for(var t=this._player.video,i=0;i<t.buffered.length;i++)if(e>=t.buffered.start(i)&&e<t.buffered.end(i))return;Be.warn(this.TAG,"seek: ",e,"tsloading:",this._tsloader.loading);var r=this._playlist.getTs(1e3*(e+.5));r&&this._tsloader.loading&&this._tsloader.url===r.url||(this._lastSeekTime=e,this._tsloader.destroy(),this._tsloader=this._context.registry("TS_LOADER",xe)({buffer:"TS_BUFFER",readtype:3}),this._presource.sources.video&&(this._presource.sources.video.data=[]),this._presource.sources.audio&&(this._presource.sources.audio.data=[]),this._tracks.audioTrack&&(this._tracks.audioTrack.samples=[]),this._tracks.videoTrack&&(this._tracks.videoTrack.samples=[]),this._compat&&this._compat.reset(),this._tsBuffer&&(this._tsBuffer.array=[],this._tsBuffer.length=0,this._tsBuffer.offset=0),this._playlist.clearDownloaded(),this._context.seek(e),this._preload(e))}},{key:"replay",value:function(){this._compat.reset(),this._playlist.clearDownloaded()}},{key:"load",value:function(e){this.url=e,this.emitTo("M3U8_LOADER",Wi.LADER_START,e,null,0)}},{key:"_preload",value:function(e){if(e=Math.floor(e),!this._tsloader.loading){Be.log(this.TAG,"preload: time=",e);var t=this.mse.container,i=-1;!e&&t.buffered.length&&(e=t.buffered.start(0));for(var r=0;r<t.buffered.length;r++)e>=Math.floor(t.buffered.start(r))&&e<=Math.ceil(t.buffered.end(r))&&(i=t.buffered.end(r));if(i<0){var n=this._playlist.getTs(1e3*(e+.5));!(n=n&&n.downloaded?this._playlist.getTs(n.time+n.duration):n)||n.downloading||n.downloaded||(this._logDownSegment(n),this._playlist.downloading(n.url,!0),this.emitTo("TS_LOADER",Wi.LADER_START,n.url))}else if(i<e+this.preloadTime){var s=this._playlist.getLastDownloadedTs()||this._playlist.getTs(1e3*i);if(s){var a=s.time+s.duration,o=s.time;if(s.downloaded)for(var u=1e3;0<u--&&((s=this._playlist.getTs(a+=10))&&!(s.time>o)););!s||s.downloading||s.downloaded||(this._logDownSegment(s),this._playlist.downloading(s.url,!0),this.emitTo("TS_LOADER",Wi.LADER_START,s.url))}}}}},{key:"cleanBuffer",value:function(){var e=this,t=this._player.currentTime,i=this._player.video,r=i.buffered;if(r&&r.length){var n=[0,0],s=i.currentTime;if(r)for(var a=0,o=r.length;a<o&&(n[0]=r.start(a),n[1]=r.end(a),!(n[0]<=s&&s<=n[1]));a++);var u=n[0],i=n[1];(10<t-u||1<r.length)&&(this.mse.remove(Math.max(Math.min(t-10,i-10),.1),0),this.bufferClearTimer=setTimeout(function(){e.bufferClearTimer=null},5e3))}}},{key:"destory",value:function(){this.configs={},this.url="",this.sequence=0,this._playlist=null,this.retrytimes=3,this.container=void 0,this.preloadTime=5,this._lastSeekTime=0,this.m3u8Text=null,this.mse=null,this.off(Wi.LOADER_COMPLETE,this._onLoaderCompete),this.off(Wi.LOADER_ERROR,this._onLoadError),this.off(zi.INIT_SEGMENT,this._onInitSegment),this.off(zi.MEDIA_SEGMENT,this._onMediaSegment),this.off(Ki.METADATA_PARSED,this._onMetadataParsed),this.off(Ki.DEMUX_COMPLETE,this._onDemuxComplete),this.off("TIME_UPDATE",this._onTimeUpdate),this.off("WAITING",this._onWaiting)}},{key:"_logDownSegment",value:function(e){e&&(Be.groupEnd(),Be.group(this.TAG,"load "+e.id+": ["+e.time/1e3+" , "+(e.time+e.duration)/1e3+"], downloading: "+e.downloading+" , donwloaded: "+e.downloaded))}}]),er),Ji="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(e,t,i){return t&&$i(e.prototype,t),i&&$i(e,i),e};function $i(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function er(e){!function(e){if(!(e instanceof er))throw new TypeError("Cannot call a class as a function")}(this),this.TAG="HlsVodController",this.configs=Object.assign({},e),this.url="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.container=this.configs.container,this.preloadTime=this.configs.preloadTime||5,this.mse=this.configs.mse,this._lastSeekTime=0,this.m3u8Text=null}var tr=function(n,s){var a=Date.now(),o=null,u=!0;return function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=Date.now();u&&(a=Date.now(),u=!1,n.apply(void 0,t)),s<r-a?(a=r,n.apply(void 0,t)):(o&&window.clearTimeout(o),o=setTimeout(function(){n.apply(void 0,t)},s))}},ir=f.HlsAllowedEvents,rr=f.REMUX_EVENTS,nr=f.HLS_EVENTS,sr=f.MSE_EVENTS,ar=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Ji(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(ur,i),s(ur,[{key:"_handleSetCurrentTime",value:function(e){(e=parseFloat(e))!==this.currentTime&&(Xi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"currentTime",e,this),this._context&&this.__core__.seek(e))}},{key:"play",value:function(){var t=this;return this.video.play().catch(function(e){e&&20===e.code&&t.once("canplay",function(){t.video.play()})})}},{key:"replay",value:function(){var e=this;this.__core__.mse.cleanBuffers().then(function(){e.__core__.replay(),Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"replay",e).call(e)})}},{key:"_initEvents",value:function(){var t=this;this.__core__.once(rr.INIT_SEGMENT,function(){var e=t.__core__.mse;Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"start",t).call(t,e.url)}),this.__core__.once(nr.RETRY_TIME_EXCEEDED,function(){t.emit("error",new i.Errors("network",t.config.url))}),this.__core__.on(sr.SOURCE_UPDATE_END,function(){t._onSourceUpdateEnd()}),this.once("canplay",function(){t.config.autoplay&&t.play()})}},{key:"initHlsBackupEvents",value:function(t,e){var i=this;t.once(rr.INIT_SEGMENT,function(){var e;i.video.src||(console.log("挂载 src blob"),e=t.mse,Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"start",i).call(i,e.url))}),t.once(f.REMUX_EVENTS.MEDIA_SEGMENT,function(){i.__core__=t,i.__core__.mse.cleanBuffers().then(function(){i.__core__.mse.resetContext(e),i.__core__.mse.doAppend(),i._context=e})}),t.once(f.LOADER_EVENTS.LOADER_ERROR,function(){e.destroy()})}},{key:"_onSourceUpdateEnd",value:function(){var e,t,i;1!==this.video.readyState&&2!==this.video.readyState||(e=(i=this.detectBufferGap()).gap,t=i.start,i=i.method,e&&("ceil"===i&&this.currentTime<Math[i](t)||"floor"===i&&this.currentTime>Math[i](t))&&(this.currentTime=Math[i](t)))}},{key:"start",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.config.url;e&&!this.started&&(this._context||(this._context=new fe(this,this.hlsOps,ir)),this.__core__=this._context.registry("HLS_VOD_CONTROLLER",Qi)({player:this,container:this.video,preloadTime:this.config.preloadTime}),this._context.init(),this.__core__.load(e),this._initEvents(),this.started=!0)}},{key:"switchURL",value:function(e){this.config.url=e;var t=new fe(this,this.hlsOps,ir),i=t.registry("HLS_VOD_CONTROLLER",Qi)({player:this,container:this.video,mse:this.__core__.mse,preloadTime:this.config.preloadTime});this.newContext=t,this.newHls=i,t.init(),this._context.destroy(),this.initHlsBackupEvents(i,t),this.__core__.mse.cleanBuffers().then(function(){i.load(e)})}},{key:"destroy",value:function(){var t=this;return new Promise(function(e){t.__core__&&t.__core__.mse?(t.__core__.mse.destroy().then(function(){t._context&&t._context.destroy(),Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"destroy",t).call(t),e()}),setTimeout(function(){e()},100)):(Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"destroy",t).call(t),setTimeout(function(){e()},50))})}},{key:"detectBufferGap",value:function(){for(var e=this.video,t={gap:!1,start:-1},i=0===this.currentTime,r=0;r<e.buffered.length;r++){var n=e.buffered.start(r),s=e.buffered.end(r);if((!e.played.length||n<=this.currentTime&&.5<=s-this.currentTime)&&!i)break;var a=n-this.currentTime,o=this.currentTime-s;if(.01<a&&(a<=2||i)){t={gap:!0,start:n,method:"ceil"};break}t=.1<o&&(o<=2||i)?{gap:!0,start:s,method:"floor"}:{gap:!1,start:-1}}return t}},{key:"currentTime",get:function(){return Yi(ur.prototype.__proto__||Object.getPrototypeOf(ur.prototype),"currentTime",this)},set:function(e){this._handleSetCurrentTime(e)}},{key:"src",get:function(){return this.currentSrc},set:function(e){var t=this;this.onWaiting=this.onWaiting.bind(this),this.__core__.mse.destroy().then(function(){t._context.destroy(),t._context=null,t.video.src="",t.video.load(),t.started=!1,t.video.currentTime=0,t.paused?t.play():(t.pause(),t.once("canplay",function(){t.play()})),t.start(e)})}},{key:"context",get:function(){return this._context}}],[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(e,t){return i.install(e,t)}}]),ur);function or(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ur(e){!function(e){if(!(e instanceof ur))throw new TypeError("Cannot call a class as a function")}(this);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Ji(t))&&"function"!=typeof t?e:t}(this,(ur.__proto__||Object.getPrototypeOf(ur)).call(this,e));return t.hlsOps={},t.util=i.util,t.util.deepCopy(t.hlsOps,e),t._handleSetCurrentTime=tr(t._handleSetCurrentTime.bind(t),200),t.onWaiting=t.onWaiting.bind(t),t}return function(e,t,i){return t&&or(e.prototype,t),i&&or(e,i),e}(lr,null,[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(e,t){return i.install(e,t)}}]),lr;function lr(e){return function(e){if(!(e instanceof lr))throw new TypeError("Cannot call a class as a function")}(this),new(e.isLive?ji:ar)(e)}});